@page "/plugins/com-multishock-twitchintegration/redeem-config"
@page "/redeem-config"
@inject RedeemConfigService RedeemConfigService
@inject IDeviceActions DeviceActions
@implements IDisposable

<div class="p-4 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold" style="color: var(--app-text, #e9ecef);">Channel Point Redemptions</h1>
            <p class="text-sm mt-1" style="color: var(--app-muted, #adb5bd);">Configure actions triggered by channel
                point redemptions</p>
        </div>
        <div class="flex items-center gap-3">
            <Toggle Label="@(RedeemConfigService.Config.Enabled ? "Enabled" : "Disabled")"
                Value="RedeemConfigService.Config.Enabled" ValueChanged="@((value) => ToggleMasterEnabled(value))" />
            <Button Text="Fetch Rewards" Variant="secondary" Disabled="@RedeemConfigService.IsFetchingRedeems"
                OnClick="@(() => FetchRewards())">
                @if (RedeemConfigService.IsFetchingRedeems)
                {
                    <svg class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 12a8 8 0 018-8m0 0a8 8 0 018 8m-8-8v4" />
                    </svg>
                }
                else
                {
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9M20 20v-5h-.581m-15.357-2a8.003 8.003 0 0115.356 2" />
                    </svg>
                }
            </Button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="mb-4 text-sm px-4 py-3 rounded"
            style="background: @(StatusIsSuccess ? "rgba(74, 158, 255, 0.1)" : "rgba(220, 38, 38, 0.1)"); color: @(StatusIsSuccess ? "#4a9eff" : "#f87171");">
            @StatusMessage
        </div>
    }

    <div class="space-y-3">
        @if (RedeemConfigService.Config.Redeems.Any())
        {
            @foreach (var redeem in RedeemConfigService.Config.Redeems.OrderBy(r => r.RewardTitle))
            {
                <div class="twitch-card @(!redeem.Enabled ? "opacity-50" : "")">
                    <div class="twitch-card-header cursor-pointer hover:opacity-80"
                        @onclick="@(() => ToggleExpanded(redeem.Id))">
                        <div class="flex items-center gap-2">
                            <div @onclick:stopPropagation="true">
                                <Toggle Value="redeem.Enabled" ValueChanged="@((e) => ToggleRedeemEnabled(redeem, e))" />
                            </div>
                            <span>@redeem.RewardTitle</span>
                            <span class="twitch-badge twitch-badge-primary">@redeem.Cost pts</span>
                            <span class="twitch-badge">@redeem.CommandType</span>
                        </div>
                        <div class="flex items-center gap-2">
                            @if (redeem.SelectedShockerIds.Any())
                            {
                                <span class="twitch-badge">@redeem.SelectedShockerIds.Count shocker@(redeem.SelectedShockerIds.Count
                                                            == 1 ? "" : "s")</span>
                            }
                            <svg class="w-4 h-4 transition-transform @(ExpandedRedeems.Contains(redeem.Id) ? "rotate-180" : "")"
                                style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    @if (ExpandedRedeems.Contains(redeem.Id))
                    {
                        <div class="twitch-card-body space-y-4">
                            <div class="flex flex-wrap items-end gap-3">
                                <div class="grow">
                                    <label class="block text-xs font-medium mb-1"
                                        style="color: var(--app-muted, #adb5bd);">Shockers</label>
                                    @{
                                        var loadedShockers = GetLoadedShockers().ToList();
                                    }
                                    @if (loadedShockers.Any())
                                    {
                                        <ShockerSelect Label="" MultiSelect="true" SelectedIds="redeem.SelectedShockerIds"
                                            SelectedIdsChanged="@(async (ids) => { redeem.SelectedShockerIds = ids; RedeemConfigService.UpdateRedeem(redeem); await InvokeAsync(StateHasChanged); })" />
                                    }
                                    else
                                    {
                                        <div class="twitch-input w-full flex items-center text-xs"
                                            style="color: var(--app-muted, #adb5bd);">
                                            No shockers
                                        </div>
                                    }
                                </div>
                                <div class="w-40">
                                    <Select Label="Mode" Value="@redeem.Mode.ToString()"
                                        ValueChanged="@((string value) => UpdateMode(redeem, ParseSelectionMode(value)))"
                                        Options="@SelectionModeOptions" />
                                </div>
                                <div class="w-40">
                                    <Select Label="Device Command" Value="@redeem.CommandType"
                                        ValueChanged="@((string value) => UpdateCommandType(redeem, value ?? "Shock"))"
                                        Options="@CommandTypeOptions" />
                                </div>
                            </div>

                            <div class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium"
                                        style="color: var(--app-muted, #adb5bd); min-width: 5rem;">Intensity</span>
                                    <Slider Min="1" Max="100" Value="redeem.Intensity"
                                        ValueChanged="@(v => UpdateIntensity(redeem, (int)v))" Class="flex-1" ShowValue="false" />
                                    <NumberInput Value="@((double)redeem.Intensity)" Min="1" Max="100"
                                        ValueChanged="@(v => UpdateIntensity(redeem, (int)Math.Clamp(v ?? 50, 1, 100)))"
                                        Class="w-16" />
                                    <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs font-medium"
                                        style="color: var(--app-muted, #adb5bd); min-width: 5rem;">Duration</span>
                                    <Slider Min="0.1" Max="15" Step="0.1" Value="redeem.Duration"
                                        ValueChanged="@(v => UpdateDuration(redeem, v))" Class="flex-1" ShowValue="false" />
                                    <NumberInput Value="redeem.Duration" Min="0.1" Max="15" Step="0.1"
                                        ValueChanged="@(v => UpdateDuration(redeem, Math.Clamp(v ?? 1.0, 0.1, 15.0)))"
                                        Class="w-16" />
                                    <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else
        {
            <div class="twitch-card">
                <div class="twitch-card-body">
                    <div class="twitch-empty py-8">
                        <svg class="w-12 h-12 mb-2" style="color: var(--app-muted, #adb5bd);" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p>No channel point rewards found</p>
                        <p class="text-xs mt-1" style="color: var(--app-muted, #adb5bd);">
                            Click "Fetch Rewards" to load your channel point rewards from Twitch
                        </p>
                        <Button Text="Fetch Rewards" Variant="primary" Class="mt-4"
                            Disabled="@RedeemConfigService.IsFetchingRedeems" OnClick="@(() => FetchRewards())" />
                    </div>
                </div>
            </div>
        }

        @if (RedeemConfigService.Config.LastFetchedUtc.HasValue)
        {
            <div class="text-xs text-center" style="color: var(--app-muted, #adb5bd);">
                Last fetched: @RedeemConfigService.Config.LastFetchedUtc.Value.ToLocalTime().ToString("g")
            </div>
        }

        <div class="twitch-card">
            <div class="twitch-card-header cursor-pointer" @onclick="@(() => ShowHelpCard = !ShowHelpCard)">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" style="color: var(--app-primary, #4a9eff);" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>How It Works</span>
                </div>
                <svg class="w-4 h-4 transition-transform @(ShowHelpCard ? "rotate-180" : "")"
                    style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            @if (ShowHelpCard)
            {
                <div class="twitch-card-body text-sm" style="color: var(--app-muted, #adb5bd);">
                    <p class="mb-2">Channel point redemptions trigger actions when viewers redeem custom rewards on your
                        channel.</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Click "Fetch Rewards" to load your channel point rewards from Twitch</li>
                        <li>Enable/disable individual rewards and configure their action settings</li>
                        <li>Each reward can have different intensity, duration, and shocker selections</li>
                        <li>Rewards that are deleted on Twitch will be removed on the next fetch</li>
                    </ul>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private HashSet<string> ExpandedRedeems = new();
    private bool ShowHelpCard = false;
    private string? StatusMessage;
    private bool StatusIsSuccess;

    private readonly Select<string>.SelectOption<string>[] SelectionModeOptions = new[]
    {
new Select<string>.SelectOption<string>("All", "All"),
new Select<string>.SelectOption<string>("Random", "Random"),
new Select<string>.SelectOption<string>("RoundRobin", "Round Robin"),
};

    private readonly Select<string>.SelectOption<string>[] CommandTypeOptions = new[]
    {
new Select<string>.SelectOption<string>("Shock", "Shock"),
new Select<string>.SelectOption<string>("Vibrate", "Vibrate"),
new Select<string>.SelectOption<string>("Beep", "Beep"),
};

    protected override void OnInitialized()
    {
        RedeemConfigService.ConfigChanged += OnConfigChanged;
        foreach (var redeem in RedeemConfigService.Config.Redeems)
        {
            ExpandedRedeems.Add(redeem.Id);
        }
    }

    private IEnumerable<ShockerInfo> GetLoadedShockers() => DeviceActions.GetLoadedShockers();

    private void OnConfigChanged() => InvokeAsync(StateHasChanged);

    private void ToggleMasterEnabled(bool enabled) => RedeemConfigService.SetEnabled(enabled);

    private void ToggleExpanded(string redeemId)
    {
        if (ExpandedRedeems.Contains(redeemId))
            ExpandedRedeems.Remove(redeemId);
        else
            ExpandedRedeems.Add(redeemId);
    }

    private void ToggleRedeemEnabled(RedeemConfig redeem, bool enabled)
    {
        RedeemConfigService.SetRedeemEnabled(redeem.Id, enabled);
    }

    private void UpdateIntensity(RedeemConfig redeem, int value)
    {
        RedeemConfigService.UpdateRedeemIntensity(redeem.Id, value);
    }

    private void UpdateDuration(RedeemConfig redeem, double value)
    {
        RedeemConfigService.UpdateRedeemDuration(redeem.Id, value);
    }

    private void UpdateMode(RedeemConfig redeem, SelectionMode mode)
    {
        RedeemConfigService.UpdateRedeemMode(redeem.Id, mode);
    }

    private void UpdateCommandType(RedeemConfig redeem, string commandType)
    {
        RedeemConfigService.UpdateRedeemCommandType(redeem.Id, commandType);
    }

    private async Task FetchRewards()
    {
        StatusMessage = null;
        await InvokeAsync(StateHasChanged);

        var result = await RedeemConfigService.FetchRedeemsAsync();
        StatusIsSuccess = result.Success;

        if (result.Success)
        {
            StatusMessage = $"{result.Message} (+{result.AddedCount} new, {result.UpdatedCount} updated)";
            foreach (var redeem in RedeemConfigService.Config.Redeems)
            {
                ExpandedRedeems.Add(redeem.Id);
            }
        }
        else
        {
            StatusMessage = result.Message;
        }

        await InvokeAsync(StateHasChanged);
    }

    private static SelectionMode ParseSelectionMode(object? value)
    {
        if (value == null) return SelectionMode.All;
        return Enum.TryParse<SelectionMode>(value.ToString(), out var mode) ? mode : SelectionMode.All;
    }

    public void Dispose()
    {
        RedeemConfigService.ConfigChanged -= OnConfigChanged;
    }
}