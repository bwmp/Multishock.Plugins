@page "/plugins/com-multishock-twitchintegration/cheer-config"
@using MultiShock.PluginSdk
@inject CheerConfigService ConfigService
@inject IDeviceActions DeviceActions
@implements IDisposable

<div class="p-4 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold" style="color: var(--app-text, #e9ecef);">Bits/Cheers Configuration</h1>
            <p class="text-sm mt-1" style="color: var(--app-muted, #adb5bd);">Configure actions triggered by Twitch
                cheers</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-3 py-2 rounded-md"
                style="background: var(--app-surface, #1e1e1e); border: 1px solid var(--app-border, #343a40);">
                <input type="checkbox" class="twitch-toggle" checked="@ConfigService.Config.Enabled"
                    @onchange="@((e) => ToggleMasterEnabled((bool)e.Value!))">
                <span class="text-sm font-medium"
                    style="color: @(ConfigService.Config.Enabled ? "var(--app-primary, #4a9eff)" : "var(--app-muted, #adb5bd)");">
                    @(ConfigService.Config.Enabled ? "Enabled" : "Disabled")
                </span>
            </div>
            <button class="twitch-btn twitch-btn-primary" @onclick="AddNewSection">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Section
            </button>
        </div>
    </div>

    <div class="space-y-3">
        @foreach (var sec in ConfigService.Config.Sections)
        {
            <div class="twitch-card @(!sec.Enabled ? "opacity-50" : "")">
                <div class="twitch-card-header cursor-pointer hover:opacity-80"
                    @onclick="@(() => ToggleSectionExpanded(sec.Id))">
                    <div class="flex items-center gap-2">
                        <div class="flex flex-col gap-0.5" @onclick:stopPropagation="true">
                            <button type="button" class="twitch-reorder-btn" title="Move Up"
                                disabled="@(ConfigService.Config.Sections.IndexOf(sec) == 0)"
                                @onclick="@(() => MoveSection(sec, -1))">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 15l7-7 7 7" />
                                </svg>
                            </button>
                            <button type="button" class="twitch-reorder-btn" title="Move Down"
                                disabled="@(ConfigService.Config.Sections.IndexOf(sec) == ConfigService.Config.Sections.Count - 1)"
                                @onclick="@(() => MoveSection(sec, 1))">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                        </div>
                        <div @onclick:stopPropagation="true">
                            <input type="checkbox" class="twitch-toggle" checked="@sec.Enabled"
                                @onchange="@((e) => ToggleSectionEnabled(sec, (bool)e.Value!))">
                        </div>
                        <span>@sec.Name</span>
                        @if (string.IsNullOrEmpty(sec.Keyword))
                        {
                            <span class="twitch-badge twitch-badge-primary">Default</span>
                        }
                        else
                        {
                            <span class="twitch-badge font-mono">"@sec.Keyword"</span>
                        }
                        <span class="twitch-badge">@sec.CommandType</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="twitch-badge">@sec.Brackets.Count brackets</span>
                        <div class="flex items-center gap-1" @onclick:stopPropagation="true">
                            <button type="button" class="twitch-toolbar-btn-sm" title="Duplicate Section"
                                @onclick="@(() => DuplicateSection(sec))">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                            </button>
                            <button type="button" class="twitch-toolbar-btn-sm danger" title="Delete Section"
                                @onclick="@(() => RemoveSection(sec))">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <svg class="w-4 h-4 transition-transform @(ExpandedSections.Contains(sec.Id) ? "rotate-180" : "")"
                            style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>

                @if (ExpandedSections.Contains(sec.Id))
                {
                    <div class="twitch-card-body space-y-4">
                        <div class="flex flex-wrap items-end gap-2">
                            <div class="grow">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Name</label>
                                <input type="text" class="twitch-input w-full" value="@sec.Name"
                                    @onchange="@((e) => UpdateSectionName(sec, e.Value?.ToString() ?? ""))">
                            </div>
                            <div class="grow">
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">
                                    Keyword <span class="opacity-60">(opt)</span>
                                </label>
                                <input type="text" class="twitch-input w-full" placeholder="e.g. shock" value="@sec.Keyword"
                                    @onchange="@((e) => UpdateSectionKeyword(sec, e.Value?.ToString() ?? ""))">
                            </div>
                            <div class="grow">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Type</label>
                                <select class="twitch-select w-full" value="@sec.CommandType"
                                    @onchange="@((e) => UpdateSectionCommandType(sec, e.Value?.ToString() ?? "Vibrate"))">
                                    <option value="Shock">Shock</option>
                                    <option value="Vibrate">Vibrate</option>
                                    <option value="Beep">Beep</option>
                                </select>
                            </div>
                            <div class="grow">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Matching</label>
                                <select class="twitch-select w-full" value="@(sec.FixedAmount ? "exact" : "round")"
                                    @onchange="@((e) => UpdateSectionFixedAmount(sec, e.Value?.ToString() == "exact"))">
                                    <option value="round">Round Down</option>
                                    <option value="exact">Exact</option>
                                </select>
                            </div>
                            <div class="grow">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Shockers</label>
                                @{
                                    var loadedShockers = GetLoadedShockers().ToList();
                                    var selectedCount = sec.SelectedShockerIds.Count;
                                }
                                @if (loadedShockers.Any())
                                {
                                    <div class="twitch-multiselect" @onclick="@(() => ToggleShockerDropdown(sec.Id))"
                                        @onclick:stopPropagation="true">
                                        <div class="twitch-multiselect-display">
                                            @if (selectedCount == 0)
                                            {
                                                <span style="color: var(--app-muted, #adb5bd);">Select...</span>
                                            }
                                            else if (selectedCount == loadedShockers.Count)
                                            {
                                                <span>All (@selectedCount)</span>
                                            }
                                            else
                                            {
                                                <span>@selectedCount selected</span>
                                            }
                                            <svg class="w-3 h-3 transition-transform @(OpenShockerDropdown == sec.Id ? "rotate-180" : "")"
                                                style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                        @if (OpenShockerDropdown == sec.Id)
                                        {
                                            <div class="twitch-multiselect-dropdown">
                                                <div class="twitch-multiselect-actions">
                                                    <button type="button" class="text-xs" style="color: var(--app-primary, #4a9eff);"
                                                        @onclick="@(() => SelectAllShockers(sec, loadedShockers))"
                                                        @onclick:stopPropagation="true">
                                                        All
                                                    </button>
                                                    <button type="button" class="text-xs" style="color: var(--app-muted, #adb5bd);"
                                                        @onclick="@(() => ClearAllShockers(sec))" @onclick:stopPropagation="true">
                                                        Clear
                                                    </button>
                                                </div>
                                                @foreach (var shocker in loadedShockers)
                                                {
                                                    var combinedId = $"{shocker.DeviceId}:{shocker.ShockerId}";
                                                    var isSelected = sec.SelectedShockerIds.Contains(combinedId);
                                                    <label class="twitch-multiselect-option @(isSelected ? "selected" : "")"
                                                        @onclick:stopPropagation="true">
                                                        <input type="checkbox" checked="@isSelected" class="twitch-checkbox"
                                                            @onchange="@(() => ToggleShockerSelection(sec, combinedId))">
                                                        <span>@shocker.Name</span>
                                                    </label>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="twitch-input w-full flex items-center text-xs"
                                        style="color: var(--app-muted, #adb5bd);">
                                        No shockers
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-3"
                            style="border-top: 1px solid var(--app-border, #343a40);">
                            <div>
                                <label class="text-sm font-medium" style="color: var(--app-text, #e9ecef);">Bit Brackets</label>
                                <p class="text-xs mt-0.5" style="color: var(--app-muted, #adb5bd);">Define intensity & duration
                                    at different bit amounts</p>
                            </div>
                            <button class="twitch-btn twitch-btn-secondary twitch-btn-sm" type="button"
                                @onclick="@(() => AddBracketToSection(sec))">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Bracket
                            </button>
                        </div>

                        <div class="space-y-2">
                            @if (sec.Brackets.Any())
                            {
                                <div class="twitch-bracket-header">
                                    <span class="w-12"></span>
                                    <span class="w-20">Bits</span>
                                    <span class="flex-1">Intensity</span>
                                    <span class="flex-1">Duration</span>
                                    <span class="w-28">Mode</span>
                                    <span class="w-8"></span>
                                </div>
                            }
                            @{
                                var orderedBrackets = sec.Brackets.OrderBy(b => b.BitAmount).ToList();
                            }
                            @foreach (var bracket in orderedBrackets)
                            {
                                <div class="twitch-bracket">
                                    <div class="flex gap-1 w-12">
                                        <button type="button" class="twitch-reorder-btn" title="Move Up"
                                            disabled="@(orderedBrackets.IndexOf(bracket) == 0)"
                                            @onclick="@(() => MoveBracket(sec, bracket, -1))">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 15l7-7 7 7" />
                                            </svg>
                                        </button>
                                        <button type="button" class="twitch-reorder-btn" title="Move Down"
                                            disabled="@(orderedBrackets.IndexOf(bracket) == orderedBrackets.Count - 1)"
                                            @onclick="@(() => MoveBracket(sec, bracket, 1))">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </button>
                                    </div>

                                    <div class="w-20">
                                        <input type="number" class="twitch-input w-full text-center font-mono" min="1"
                                            value="@bracket.BitAmount"
                                            @onchange="@((e) => UpdateBracketBitAmount(sec, bracket, ParseInt(e.Value, 100)))">
                                    </div>

                                    <div class="flex items-center gap-2 flex-1">
                                        <input type="range" class="twitch-slider" style="flex: 1 1 0; min-width: 0;" min="1"
                                            max="100" value="@bracket.Intensity"
                                            @oninput="@((e) => UpdateBracketIntensity(sec, bracket, ParseInt(e.Value, 50)))">
                                        <input type="number" class="twitch-input text-center text-xs font-mono"
                                            style="width: 3.5rem; flex-shrink: 0;" min="1" max="100" value="@bracket.Intensity"
                                            @onchange="@((e) => UpdateBracketIntensity(sec, bracket, Math.Clamp(ParseInt(e.Value, 50), 1, 100)))">
                                        <span class="text-xs" style="color: var(--app-muted, #adb5bd); flex-shrink: 0;">%</span>
                                    </div>

                                    <div class="flex items-center gap-2 flex-1">
                                        <input type="range" class="twitch-slider" style="flex: 1 1 0; min-width: 0;" min="0.1"
                                            max="15" step="0.1" value="@bracket.Duration"
                                            @oninput="@((e) => UpdateBracketDuration(sec, bracket, ParseDouble(e.Value, 1.0)))">
                                        <input type="number" class="twitch-input text-center text-xs font-mono"
                                            style="width: 4rem; flex-shrink: 0;" min="0.1" max="15" step="0.1"
                                            value="@bracket.Duration.ToString("0.0")"
                                            @onchange="@((e) => UpdateBracketDuration(sec, bracket, Math.Clamp(ParseDouble(e.Value, 1.0), 0.1, 15.0)))">
                                        <span class="text-xs" style="color: var(--app-muted, #adb5bd); flex-shrink: 0;">s</span>
                                    </div>

                                    <div class="w-28">
                                        <select class="twitch-select w-full text-xs" value="@bracket.Mode.ToString()"
                                            @onchange="@((e) => UpdateBracketMode(sec, bracket, ParseSelectionMode(e.Value)))">
                                            <option value="All">All</option>
                                            <option value="Random">Random</option>
                                            <option value="RoundRobin">Round Robin</option>
                                        </select>
                                    </div>

                                    <button type="button" class="twitch-toolbar-btn danger" title="Delete Bracket"
                                        @onclick="@(() => RemoveBracket(sec, bracket))">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                    </button>
                                </div>
                            }
                            @if (!sec.Brackets.Any())
                            {
                                <div class="twitch-empty">
                                    <p>No brackets configured</p>
                                    <p class="text-xs">Add a bracket to define behavior at different bit amounts</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }

        @if (!ConfigService.Config.Sections.Any())
        {
            <div class="twitch-card">
                <div class="twitch-card-body">
                    <div class="twitch-empty py-8">
                        <svg class="w-12 h-12 mb-2" style="color: var(--app-muted, #adb5bd);" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p>No sections configured</p>
                        <button class="twitch-btn twitch-btn-primary mt-4" type="button" @onclick="AddNewSection">
                            Create Your First Section
                        </button>
                    </div>
                </div>
            </div>
        }

        <div class="twitch-card">
            <div class="twitch-card-header cursor-pointer" @onclick="@(() => ShowHelpCard = !ShowHelpCard)">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" style="color: var(--app-primary, #4a9eff);" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>How It Works</span>
                </div>
                <svg class="w-4 h-4 transition-transform @(ShowHelpCard ? "rotate-180" : "")"
                    style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            @if (ShowHelpCard)
            {
                <div class="twitch-card-body text-sm" style="color: var(--app-muted, #adb5bd);">
                    <p class="mb-3">When a cheer arrives, keywords are matched to sections. The matching section's bracket
                        (based on bit amount) determines the action.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private HashSet<string> ExpandedSections = new();
    private string? OpenShockerDropdown = null;
    private bool ShowHelpCard = false;

    protected override void OnInitialized()
    {
        ConfigService.ConfigChanged += OnConfigChanged;
        foreach (var sec in ConfigService.Config.Sections)
        {
            ExpandedSections.Add(sec.Id);
        }
    }

    private IEnumerable<ShockerInfo> GetLoadedShockers() => DeviceActions.GetLoadedShockers();

    private static int ParseInt(object? value, int defaultValue)
    {
        if (value == null) return defaultValue;
        return int.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static double ParseDouble(object? value, double defaultValue)
    {
        if (value == null) return defaultValue;
        return double.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static SelectionMode ParseSelectionMode(object? value)
    {
        if (value == null) return SelectionMode.All;
        return Enum.TryParse<SelectionMode>(value.ToString(), out var result) ? result : SelectionMode.All;
    }

    private void OnConfigChanged() => InvokeAsync(StateHasChanged);

    private void ToggleMasterEnabled(bool enabled) => ConfigService.SetEnabled(enabled);

    private void ToggleSectionExpanded(string sectionId)
    {
        if (ExpandedSections.Contains(sectionId))
            ExpandedSections.Remove(sectionId);
        else
            ExpandedSections.Add(sectionId);
    }

    private void ToggleShockerDropdown(string sectionId)
    {
        OpenShockerDropdown = OpenShockerDropdown == sectionId ? null : sectionId;
    }

    private void SelectAllShockers(CheerSection sec, List<ShockerInfo> shockers)
    {
        foreach (var shocker in shockers)
        {
            var combinedId = $"{shocker.DeviceId}:{shocker.ShockerId}";
            if (!sec.SelectedShockerIds.Contains(combinedId))
                sec.SelectedShockerIds.Add(combinedId);
        }
        ConfigService.UpdateSection(sec);
    }

    private void ClearAllShockers(CheerSection sec)
    {
        sec.SelectedShockerIds.Clear();
        ConfigService.UpdateSection(sec);
    }

    private void ToggleSectionEnabled(CheerSection sec, bool enabled)
    {
        sec.Enabled = enabled;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionName(CheerSection sec, string name)
    {
        sec.Name = name;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionKeyword(CheerSection sec, string keyword)
    {
        sec.Keyword = keyword;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionCommandType(CheerSection sec, string commandType)
    {
        sec.CommandType = commandType;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionFixedAmount(CheerSection sec, bool fixedAmount)
    {
        sec.FixedAmount = fixedAmount;
        ConfigService.UpdateSection(sec);
    }

    private void ToggleShockerSelection(CheerSection sec, string shockerId)
    {
        if (sec.SelectedShockerIds.Contains(shockerId))
            sec.SelectedShockerIds.Remove(shockerId);
        else
            sec.SelectedShockerIds.Add(shockerId);
        ConfigService.UpdateSection(sec);
    }

    private void AddNewSection()
    {
        var newSection = new CheerSection
        {
            Name = $"Section {ConfigService.Config.Sections.Count + 1}",
            Keyword = "",
            Enabled = true,
            CommandType = "Vibrate"
        };
        ConfigService.AddSection(newSection);
        ExpandedSections.Add(newSection.Id);
    }

    private void RemoveSection(CheerSection sec)
    {
        ExpandedSections.Remove(sec.Id);
        ConfigService.RemoveSection(sec.Id);
    }

    private void AddBracketToSection(CheerSection sec)
    {
        var newBracket = new CheerBracket
        {
            BitAmount = 100,
            Intensity = 50,
            Duration = 1.0,
            Mode = SelectionMode.All
        };
        ConfigService.AddBracket(sec.Id, newBracket);
    }

    private void UpdateBracketBitAmount(CheerSection sec, CheerBracket bracket, int bitAmount)
    {
        bracket.BitAmount = Math.Max(1, bitAmount);
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void UpdateBracketIntensity(CheerSection sec, CheerBracket bracket, int intensity)
    {
        bracket.Intensity = Math.Clamp(intensity, 1, 100);
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void UpdateBracketDuration(CheerSection sec, CheerBracket bracket, double duration)
    {
        bracket.Duration = Math.Clamp(duration, 0.1, 15.0);
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void UpdateBracketMode(CheerSection sec, CheerBracket bracket, SelectionMode mode)
    {
        bracket.Mode = mode;
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void RemoveBracket(CheerSection sec, CheerBracket bracket)
    {
        ConfigService.RemoveBracket(sec.Id, bracket.Id);
    }

    private void MoveSection(CheerSection sec, int direction)
    {
        ConfigService.MoveSection(sec.Id, direction);
    }

    private void DuplicateSection(CheerSection sec)
    {
        var duplicate = ConfigService.DuplicateSection(sec.Id);
        if (duplicate != null)
        {
            ExpandedSections.Add(duplicate.Id);
        }
    }

    private void MoveBracket(CheerSection sec, CheerBracket bracket, int direction)
    {
        ConfigService.MoveBracket(sec.Id, bracket.Id, direction);
    }

    public void Dispose()
    {
        ConfigService.ConfigChanged -= OnConfigChanged;
    }
}