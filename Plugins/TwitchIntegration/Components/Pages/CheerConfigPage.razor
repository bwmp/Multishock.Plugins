@page "/plugins/com-multishock-twitchintegration/cheer-config"
@using MultiShock.PluginSdk
@inject IDeviceActions DeviceActions
@implements IDisposable
@using global::TwitchIntegration.Components.Config

<div class="p-4 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold" style="color: var(--app-text, #e9ecef);">Bits/Cheers Configurationnnn</h1>
            <p class="text-sm mt-1" style="color: var(--app-muted, #adb5bd);">Configure actions triggered by Twitch
                cheers</p>
        </div>
        <div class="flex items-center gap-3">
            <Toggle Label="@(ConfigService.Config.Enabled ? "Enabled" : "Disabled")"
                Value="ConfigService.Config.Enabled" ValueChanged="@((value) => ToggleMasterEnabled(value))" />
            <Button Text="Add Section" Variant="primary" OnClick="@(() => AddNewSection())">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </Button>
        </div>
    </div>

    <div class="space-y-3">
        @foreach (var sec in ConfigService.Config.Sections)
        {
            <div class="twitch-card @(!sec.Enabled ? "opacity-50" : "")">
                <div class="twitch-card-header cursor-pointer hover:opacity-80"
                    @onclick="@(() => ToggleSectionExpanded(sec.Id))">
                    <div class="flex items-center gap-2">
                        <div class="flex gap-1 w-16" @onclick:stopPropagation="true">
                            <Button Variant="outline" Size="icon-sm"
                                Disabled="@(ConfigService.Config.Sections.IndexOf(sec) == 0)"
                                OnClick="@(() => MoveSection(sec, -1))" Class="w-8 h-8 flex items-center justify-center">
                                <LucideIcon Name="arrow-up" Class="w-6 h-6" />
                            </Button>
                            <Button Variant="outline" Size="icon-sm"
                                Disabled="@(ConfigService.Config.Sections.IndexOf(sec) == ConfigService.Config.Sections.Count - 1)"
                                OnClick="@(() => MoveSection(sec, 1))" Class="w-8 h-8 flex items-center justify-center">
                                <LucideIcon Name="arrow-down" Class="w-6 h-6" />
                            </Button>
                        </div>
                        <div @onclick:stopPropagation="true">
                            <Toggle Value="sec.Enabled" ValueChanged="@((e) => ToggleSectionEnabled(sec, e))" />
                        </div>
                        <span>@sec.Name</span>
                        @if (string.IsNullOrEmpty(sec.Keyword))
                        {
                            <span class="twitch-badge twitch-badge-primary">Default</span>
                        }
                        else
                        {
                            <span class="twitch-badge font-mono">"@sec.Keyword"</span>
                        }
                        <span class="twitch-badge">@sec.CommandType</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="twitch-badge">@sec.Brackets.Count brackets</span>
                        <div class="flex items-center gap-1" @onclick:stopPropagation="true">
                            <Button Variant="outline" Size="icon-sm" OnClick="@(() => DuplicateSection(sec))"
                                Class="w-8 h-8 flex items-center justify-center">
                                <LucideIcon Name="copy" Class="w-6 h-6" />
                            </Button>
                            <Button Variant="danger" Size="icon-sm" OnClick="@(() => RemoveSection(sec))"
                                Class="w-8 h-8 flex items-center justify-center">
                                <LucideIcon Name="trash2" Class="w-6 h-6" />
                            </Button>
                        </div>
                        <svg class="w-4 h-4 transition-transform @(ExpandedSections.Contains(sec.Id) ? "rotate-180" : "")"
                            style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>

                @if (ExpandedSections.Contains(sec.Id))
                {
                    <div class="twitch-card-body space-y-4">
                        <div class="flex flex-wrap items-end gap-2">
                            <div class="grow">
                                <TextInput Label="Name" Value="@sec.Name"
                                    ValueChanged="@((value) => UpdateSectionName(sec, value ?? ""))" />
                            </div>
                            <div class="grow">
                                <TextInput Label="Keyword (opt)" Placeholder="e.g. shock" Value="@sec.Keyword"
                                    ValueChanged="@((value) => UpdateSectionKeyword(sec, value ?? ""))" />
                            </div>
                            <div class="grow">
                                <Select Label="Type" Value="@sec.CommandType"
                                    ValueChanged="@((string value) => UpdateSectionCommandType(sec, value ?? "Vibrate"))"
                                    Options="@CommandTypeOptions" />
                            </div>
                            <div class="grow">
                                <Select Label="Matching" Value="@(sec.FixedAmount ? "exact" : "round")"
                                    ValueChanged="@((string value) => UpdateSectionFixedAmount(sec, value == "exact"))"
                                    Options="@MatchingModeOptions" />
                            </div>
                            <div class="grow">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Shockers</label>
                                @{
                                    var loadedShockers = GetLoadedShockers().ToList();
                                    var selectedCount = sec.SelectedShockerIds.Count;
                                }
                                @if (loadedShockers.Any())
                                {
                                    <ShockerSelect Label="" MultiSelect="true" SelectedIds="sec.SelectedShockerIds"
                                        SelectedIdsChanged="@(async (ids) => { sec.SelectedShockerIds = ids; ConfigService.UpdateSection(sec); })" />
                                }
                                else
                                {
                                    <div class="twitch-input w-full flex items-center text-xs"
                                        style="color: var(--app-muted, #adb5bd);">
                                        No shockers
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-3"
                            style="border-top: 1px solid var(--app-border, #343a40);">
                            <div>
                                <label class="text-sm font-medium" style="color: var(--app-text, #e9ecef);">Bit Brackets</label>
                                <p class="text-xs mt-0.5" style="color: var(--app-muted, #adb5bd);">Define intensity & duration
                                    at different bit amounts</p>
                            </div>
                            <Button Text="Add Bracket" Variant="secondary" Size="sm"
                                OnClick="@(() => AddBracketToSection(sec))">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </Button>
                        </div>

                        <BracketList TBracket="CheerBracket" CountLabel="Bits" Brackets="sec.Brackets"
                            SelectionModeOptions="SelectionModeOptions" CountSelector="@(b => b.BitAmount)"
                            IntensitySelector="@(b => b.Intensity)" DurationSelector="@(b => b.Duration)"
                            ModeSelector="@(b => b.Mode.ToString())" OnMoveUp="@(bracket => MoveBracket(sec, bracket, -1))"
                            OnMoveDown="@(bracket => MoveBracket(sec, bracket, 1))"
                            OnCountChanged="@(change => UpdateBracketBitAmount(sec, change.Bracket, change.Value))"
                            OnIntensityChanged="@(change => UpdateBracketIntensity(sec, change.Bracket, change.Value))"
                            OnDurationChanged="@(change => UpdateBracketDuration(sec, change.Bracket, change.Value))"
                            OnModeChanged="@(change => UpdateBracketMode(sec, change.Bracket, ParseSelectionMode(change.Value)))"
                            OnRemove="@(bracket => RemoveBracket(sec, bracket))" EmptyTitle="No brackets configured"
                            EmptyDescription="Add a bracket to define behavior at different bit amounts" />
                    </div>
                }
            </div>
        }

        @if (!ConfigService.Config.Sections.Any())
        {
            <div class="twitch-card">
                <div class="twitch-card-body">
                    <div class="twitch-empty py-8">
                        <svg class="w-12 h-12 mb-2" style="color: var(--app-muted, #adb5bd);" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p>No sections configured</p>
                        <Button Text="Create Your First Section" Variant="primary" Class="mt-4"
                            OnClick="@(() => AddNewSection())" />
                    </div>
                </div>
            </div>
        }

        <div class="twitch-card">
            <div class="twitch-card-header cursor-pointer" @onclick="@(() => ShowHelpCard = !ShowHelpCard)">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" style="color: var(--app-primary, #4a9eff);" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>How It Works</span>
                </div>
                <svg class="w-4 h-4 transition-transform @(ShowHelpCard ? "rotate-180" : "")"
                    style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            @if (ShowHelpCard)
            {
                <div class="twitch-card-body text-sm" style="color: var(--app-muted, #adb5bd);">
                    <p class="mb-3">When a cheer arrives, keywords are matched to sections. The matching section's bracket
                        (based on bit amount) determines the action.</p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string pluginId = TwitchIntegration.TwitchIntegrationPlugin.PluginId;
    private CheerConfigService ConfigService => PluginServiceLocator.GetRequiredService<CheerConfigService>(pluginId);

    private HashSet<string> ExpandedSections = new();
    private string? OpenShockerDropdown = null;
    private bool ShowHelpCard = false;

    private Select<string>.SelectOption<string>[] CommandTypeOptions = new[]
    {
new Select<string>.SelectOption<string>("Shock", "Shock"),
new Select<string>.SelectOption<string>("Vibrate", "Vibrate"),
new Select<string>.SelectOption<string>("Beep", "Beep")
};

    private Select<string>.SelectOption<string>[] MatchingModeOptions = new[]
    {
new Select<string>.SelectOption<string>("round", "Round Down"),
new Select<string>.SelectOption<string>("exact", "Exact")
};

    private Select<string>.SelectOption<string>[] SelectionModeOptions = new[]
    {
new Select<string>.SelectOption<string>("All", "All"),
new Select<string>.SelectOption<string>("Random", "Random"),
new Select<string>.SelectOption<string>("RoundRobin", "Round Robin")
};

    protected override void OnInitialized()
    {
        ConfigService.ConfigChanged += OnConfigChanged;
        foreach (var sec in ConfigService.Config.Sections)
        {
            ExpandedSections.Add(sec.Id);
        }
    }

    private IEnumerable<ShockerInfo> GetLoadedShockers() => DeviceActions.GetLoadedShockers();

    private static int ParseInt(object? value, int defaultValue)
    {
        if (value == null) return defaultValue;
        return int.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static double ParseDouble(object? value, double defaultValue)
    {
        if (value == null) return defaultValue;
        return double.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static SelectionMode ParseSelectionMode(object? value)
    {
        if (value == null) return SelectionMode.All;
        return Enum.TryParse<SelectionMode>(value.ToString(), out var result) ? result : SelectionMode.All;
    }

    private void OnConfigChanged() => InvokeAsync(StateHasChanged);

    private void ToggleMasterEnabled(bool enabled) => ConfigService.SetEnabled(enabled);

    private void ToggleSectionExpanded(string sectionId)
    {
        if (ExpandedSections.Contains(sectionId))
            ExpandedSections.Remove(sectionId);
        else
            ExpandedSections.Add(sectionId);
    }

    private void ToggleShockerDropdown(string sectionId)
    {
        OpenShockerDropdown = OpenShockerDropdown == sectionId ? null : sectionId;
    }

    private void SelectAllShockers(CheerSection sec, List<ShockerInfo> shockers)
    {
        foreach (var shocker in shockers)
        {
            var combinedId = $"{shocker.DeviceId}:{shocker.ShockerId}";
            if (!sec.SelectedShockerIds.Contains(combinedId))
                sec.SelectedShockerIds.Add(combinedId);
        }
        ConfigService.UpdateSection(sec);
    }

    private void ClearAllShockers(CheerSection sec)
    {
        sec.SelectedShockerIds.Clear();
        ConfigService.UpdateSection(sec);
    }

    private void ToggleSectionEnabled(CheerSection sec, bool enabled)
    {
        sec.Enabled = enabled;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionName(CheerSection sec, string name)
    {
        sec.Name = name;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionKeyword(CheerSection sec, string keyword)
    {
        sec.Keyword = keyword;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionCommandType(CheerSection sec, string commandType)
    {
        sec.CommandType = commandType;
        ConfigService.UpdateSection(sec);
    }

    private void UpdateSectionFixedAmount(CheerSection sec, bool fixedAmount)
    {
        sec.FixedAmount = fixedAmount;
        ConfigService.UpdateSection(sec);
    }

    private void ToggleShockerSelection(CheerSection sec, string shockerId)
    {
        if (sec.SelectedShockerIds.Contains(shockerId))
            sec.SelectedShockerIds.Remove(shockerId);
        else
            sec.SelectedShockerIds.Add(shockerId);
        ConfigService.UpdateSection(sec);
    }

    private void AddNewSection()
    {
        var newSection = new CheerSection
        {
            Name = $"Section {ConfigService.Config.Sections.Count + 1}",
            Keyword = "",
            Enabled = true,
            CommandType = "Vibrate"
        };
        ConfigService.AddSection(newSection);
        ExpandedSections.Add(newSection.Id);
    }

    private void RemoveSection(CheerSection sec)
    {
        ExpandedSections.Remove(sec.Id);
        ConfigService.RemoveSection(sec.Id);
    }

    private void AddBracketToSection(CheerSection sec)
    {
        var newBracket = new CheerBracket
        {
            BitAmount = 100,
            Intensity = 50,
            Duration = 1.0,
            Mode = SelectionMode.All
        };
        ConfigService.AddBracket(sec.Id, newBracket);
    }

    private void UpdateBracketBitAmount(CheerSection sec, CheerBracket bracket, int bitAmount)
    {
        bracket.BitAmount = Math.Max(1, bitAmount);
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void UpdateBracketIntensity(CheerSection sec, CheerBracket bracket, int intensity)
    {
        bracket.Intensity = Math.Clamp(intensity, 1, 100);
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void UpdateBracketDuration(CheerSection sec, CheerBracket bracket, double duration)
    {
        bracket.Duration = Math.Clamp(duration, 0.1, 15.0);
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void UpdateBracketMode(CheerSection sec, CheerBracket bracket, SelectionMode mode)
    {
        bracket.Mode = mode;
        ConfigService.UpdateBracket(sec.Id, bracket);
    }

    private void RemoveBracket(CheerSection sec, CheerBracket bracket)
    {
        ConfigService.RemoveBracket(sec.Id, bracket.Id);
    }

    private void MoveSection(CheerSection sec, int direction)
    {
        ConfigService.MoveSection(sec.Id, direction);
    }

    private void DuplicateSection(CheerSection sec)
    {
        var duplicate = ConfigService.DuplicateSection(sec.Id);
        if (duplicate != null)
        {
            ExpandedSections.Add(duplicate.Id);
        }
    }

    private void MoveBracket(CheerSection sec, CheerBracket bracket, int direction)
    {
        ConfigService.MoveBracket(sec.Id, bracket.Id, direction);
    }

    public void Dispose()
    {
        ConfigService.ConfigChanged -= OnConfigChanged;
    }
}