@page "/plugins/com-multishock-twitchintegration/sub-config"
@using MultiShock.PluginSdk
@inject IDeviceActions DeviceActions
@implements IDisposable
@using global::TwitchIntegration.Components.Config

<div class="p-4 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold" style="color: var(--app-text, #e9ecef);">Subscriptions Configuration</h1>
            <p class="text-sm mt-1" style="color: var(--app-muted, #adb5bd);">Configure actions triggered by
                subscriptions and gifted subs</p>
        </div>
        <div class="flex items-center gap-3">
            <Toggle Label="@(SubConfigService.Config.Enabled ? "Enabled" : "Disabled")"
                Value="SubConfigService.Config.Enabled" ValueChanged="@((value) => ToggleMasterEnabled(value))" />
        </div>
    </div>

    <div class="space-y-3">
        @foreach (var sec in SubConfigService.Config.Sections.OrderBy(s => s.Tier))
        {
            <div class="twitch-card @(!sec.Enabled ? "opacity-50" : "")">
                <div class="twitch-card-header cursor-pointer hover:opacity-80"
                    @onclick="@(() => ToggleSectionExpanded(sec.Id))">
                    <div class="flex items-center gap-2">
                        <div @onclick:stopPropagation="true">
                            <Toggle Value="sec.Enabled" ValueChanged="@((e) => ToggleSectionEnabled(sec, e))" />
                        </div>
                        <span>Tier @sec.Tier</span>
                        <span class="twitch-badge">@sec.SelectedShockerIds.Count shockers</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 transition-transform @(ExpandedSections.Contains(sec.Id) ? "rotate-180" : "")"
                            style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>

                @if (ExpandedSections.Contains(sec.Id))
                {
                    <div class="twitch-card-body space-y-4">
                        <div class="flex flex-wrap items-end gap-2">
                            <div class="w-40">
                                <Select Label="Mode" Value="@sec.Mode.ToString()"
                                    ValueChanged="@((string value) => UpdateSectionMode(sec, ParseSubscriptionMode(value)))"
                                    Options="@SubscriptionModeOptions" />
                            </div>

                            <div class="grow">
                                <ShockerSelect Label="" MultiSelect="true" SelectedIds="sec.SelectedShockerIds"
                                    SelectedIdsChanged="@(async (ids) => { sec.SelectedShockerIds = ids; SubConfigService.UpdateSection(sec); })" />
                            </div>
                        </div>
                        @if (sec.Mode == SubscriptionMode.Brackets)
                        {
                            <div class="pt-3" style="border-top: 1px solid var(--app-border, #343a40);">
                                <div class="flex flex-wrap items-end gap-3 mb-3">
                                    <div class="grow">
                                        <Select Label="Command Type" Value="@sec.BracketCommandType"
                                            ValueChanged="@((string value) => UpdateBracketCommandType(sec, value ?? "Vibrate"))"
                                            Options="@CommandTypeOptions" />
                                    </div>
                                    <div class="w-40">
                                        <Select Label="Matching" Value="@(sec.FixedAmount ? "exact" : "round")"
                                            ValueChanged="@((string value) => UpdateSectionFixedAmount(sec, value == "exact"))"
                                            Options="@MatchingModeOptions" />
                                    </div>
                                    <Button Text="Add Bracket" Variant="secondary" Size="sm" OnClick="@(() => AddBracket(sec))">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4" />
                                        </svg>
                                    </Button>
                                    @if (CheerConfigService.Config.Sections.Any())
                                    {
                                        <div class="flex items-end gap-2">
                                            <div>
                                                <Select Label="Import from Cheers" Value="@SelectedCheerSectionIdForImport"
                                                    ValueChanged="@((string value) => SelectedCheerSectionIdForImport = value)"
                                                    Options="@CheerConfigService.Config.Sections.Select(cs => new Select<string?>.SelectOption<string?>(cs.Id, cs.Name))" />
                                            </div>
                                            <Button Text="Convert" Variant="secondary" Size="sm"
                                                OnClick="@(() => ConvertFromCheerSection(sec))" />
                                        </div>
                                    }
                                </div>

                                <BracketList TBracket="SubscriptionBracket" CountLabel="Subs" Brackets="sec.Brackets"
                                    SelectionModeOptions="SelectionModeOptions"
                                    CountSelector="@(b => b.Count)"
                                    IntensitySelector="@(b => b.Intensity)"
                                    DurationSelector="@(b => b.Duration)"
                                    ModeSelector="@(b => b.Mode.ToString())"
                                    OnMoveUp="@(bracket => MoveBracket(sec, bracket, -1))"
                                    OnMoveDown="@(bracket => MoveBracket(sec, bracket, 1))"
                                    OnCountChanged="@(change => UpdateBracketCount(sec, change.Bracket, change.Value))"
                                    OnIntensityChanged="@(change => UpdateBracketIntensity(sec, change.Bracket, change.Value))"
                                    OnDurationChanged="@(change => UpdateBracketDuration(sec, change.Bracket, change.Value))"
                                    OnModeChanged="@(change => UpdateBracketMode(sec, change.Bracket, ParseSelectionMode(change.Value)))"
                                    OnRemove="@(bracket => RemoveBracket(sec, bracket))"
                                    EmptyTitle="No brackets configured"
                                    EmptyDescription="Add a bracket to define behavior at different sub counts" />
                            </div>
                        }

                        @if (sec.Mode == SubscriptionMode.Incremental)
                        {
                            <div class="pt-3" style="border-top: 1px solid var(--app-border, #343a40);">
                                <div class="flex items-center justify-between mb-2">
                                    <div>
                                        <label class="text-sm font-medium" style="color: var(--app-text, #e9ecef);">Incremental
                                            Subs</label>
                                        <p class="text-xs mt-0.5" style="color: var(--app-muted, #adb5bd);">
                                            Base values apply to 1 sub. Each additional sub (including gifts) increases intensity
                                            and duration by the increment values, up to the max.
                                        </p>
                                    </div>
                                </div>

                                <div class="space-y-2 mb-3">
                                    <div class="flex flex-wrap items-start gap-3">
                                        <span class="text-xs font-semibold"
                                            style="color: var(--app-muted, #adb5bd); min-width: 4rem; padding-top: 0.35rem;">Intensity</span>
                                        <div class="flex-1 min-w-0 space-y-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Base</span>
                                                <Slider Min="1" Max="100" Value="sec.Incremental.BaseIntensity"
                                                    ValueChanged="@((v) => UpdateIncrementalBaseIntensity(sec, (int)v))"
                                                    Class="flex-1" ShowValue="false" />
                                                <NumberInput Value="@((double)sec.Incremental.BaseIntensity)" Min="1" Max="100"
                                                    ValueChanged="@((v) => UpdateIncrementalBaseIntensity(sec, (int)Math.Clamp(v ?? 50, 1, 100)))"
                                                    Class="w-16" />
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Max</span>
                                                <Slider Min="1" Max="100" Value="sec.Incremental.MaxIntensity"
                                                    ValueChanged="@((v) => UpdateIncrementalMaxIntensity(sec, (int)v))"
                                                    Class="flex-1" ShowValue="false" />
                                                <NumberInput Value="@((double)sec.Incremental.MaxIntensity)" Min="1" Max="100"
                                                    ValueChanged="@((v) => UpdateIncrementalMaxIntensity(sec, (int)Math.Clamp(v ?? 100, 1, 100)))"
                                                    Class="w-16" />
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-1">
                                            <span class="text-xs" style="color: var(--app-muted, #adb5bd);">+ /sub</span>
                                            <div class="flex items-center gap-2">
                                                <NumberInput Value="@((double)sec.Incremental.IncrementIntensity)" Min="0" Max="100"
                                                    ValueChanged="@((v) => UpdateIncrementalIntensityIncrement(sec, (int)Math.Clamp(v ?? 5, 0, 100)))"
                                                    Class="w-16" />
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap items-start gap-3">
                                        <span class="text-xs font-semibold"
                                            style="color: var(--app-muted, #adb5bd); min-width: 4rem; padding-top: 0.35rem;">Duration</span>
                                        <div class="flex-1 min-w-0 space-y-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Base</span>
                                                <Slider Min="0.1" Max="15" Step="0.1" Value="sec.Incremental.BaseDuration"
                                                    ValueChanged="@((v) => UpdateIncrementalBaseDuration(sec, v))" Class="flex-1"
                                                    ShowValue="false" />
                                                <NumberInput Value="sec.Incremental.BaseDuration" Min="0.1" Max="15" Step="0.1"
                                                    ValueChanged="@((v) => UpdateIncrementalBaseDuration(sec, Math.Clamp(v ?? 1.0, 0.1, 15.0)))"
                                                    Class="w-16" />
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Max</span>
                                                <Slider Min="0.1" Max="15" Step="0.1" Value="sec.Incremental.MaxDuration"
                                                    ValueChanged="@((v) => UpdateIncrementalMaxDuration(sec, v))" Class="flex-1"
                                                    ShowValue="false" />
                                                <NumberInput Value="sec.Incremental.MaxDuration" Min="0.1" Max="15" Step="0.1"
                                                    ValueChanged="@((v) => UpdateIncrementalMaxDuration(sec, Math.Clamp(v ?? 5.0, 0.1, 15.0)))"
                                                    Class="w-16" />
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-1">
                                            <span class="text-xs" style="color: var(--app-muted, #adb5bd);">+ /sub</span>
                                            <div class="flex items-center gap-2">
                                                <NumberInput Value="sec.Incremental.IncrementDuration" Min="0" Max="15" Step="0.1"
                                                    ValueChanged="@((v) => UpdateIncrementalDurationIncrement(sec, Math.Clamp(v ?? 0.5, 0.0, 15.0)))"
                                                    Class="w-16" />
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <span class="text-xs font-semibold" style="color: var(--app-muted, #adb5bd);">Mode / Type</span>
                                    <div class="flex flex-col gap-1">
                                        <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Mode &amp; Command</span>
                                        <div class="flex gap-2">
                                            <Select Label="" Value="@sec.Incremental.Mode.ToString()"
                                                ValueChanged="@((string value) => UpdateIncrementalMode(sec, ParseSelectionMode(value)))"
                                                Options="@SelectionModeOptions" Class="flex-1" />
                                            <Select Label="" Value="@sec.Incremental.CommandType"
                                                ValueChanged="@((string value) => UpdateIncrementalCommandType(sec, value ?? "Vibrate"))"
                                                Options="@CommandTypeOptions" Class="flex-1" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (!SubConfigService.Config.Sections.Any())
                {
                    <div class="twitch-card">
                        <div class="twitch-card-body">
                            <div class="twitch-empty py-8">
                                <p>No subscription tiers configured</p>
                                <p class="text-xs" style="color: var(--app-muted, #adb5bd);">This plugin normally creates one
                                    section per tier automatically.</p>
                            </div>
                        </div>
                    </div>
                }

                <div class="twitch-card">
                    <div class="twitch-card-header cursor-pointer" @onclick="@(() => ShowHelpCard = !ShowHelpCard)">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" style="color: var(--app-primary, #4a9eff);" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>How It Works</span>
                        </div>
                        <svg class="w-4 h-4 transition-transform @(ShowHelpCard ? "rotate-180" : "")"
                            style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    @if (ShowHelpCard)
                    {
                        <div class="twitch-card-body text-sm" style="color: var(--app-muted, #adb5bd);">
                            <p class="mb-2">When a subscription event arrives, the matching tier section is used.</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>In <strong>Brackets</strong> mode, subs use the matching bracket based on sub count (1 for
                                    single, gift count for gifts).</li>
                                <li>In <strong>Incremental</strong> mode, both single subs and gifts use the incremental scaling
                                    based on sub count.</li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>
@code {
    // Use service locator instead of @inject for plugin-specific services
    // This survives hot-reload where the DI container has stale types
    private const string PluginId = "com.multishock.twitchintegration";
    private SubscriptionConfigService SubConfigService => PluginServiceLocator.GetRequiredService<SubscriptionConfigService>(PluginId);
    private CheerConfigService CheerConfigService => PluginServiceLocator.GetRequiredService<CheerConfigService>(PluginId);
    
    private HashSet<string> ExpandedSections = new();
    private bool ShowHelpCard = false;
    private string? SelectedCheerSectionIdForImport;

    private Select<string>.SelectOption<string>[] CommandTypeOptions = new[]
    {
new Select<string>.SelectOption<string>("Shock", "Shock"),
new Select<string>.SelectOption<string>("Vibrate", "Vibrate"),
new Select<string>.SelectOption<string>("Beep", "Beep")
};

    private Select<string>.SelectOption<string>[] MatchingModeOptions = new[]
    {
new Select<string>.SelectOption<string>("round", "Round Down"),
new Select<string>.SelectOption<string>("exact", "Exact")
};

    private Select<string>.SelectOption<string>[] SelectionModeOptions = new[]
    {
new Select<string>.SelectOption<string>("All", "All"),
new Select<string>.SelectOption<string>("Random", "Random"),
new Select<string>.SelectOption<string>("RoundRobin", "Round Robin")
};

    private Select<string>.SelectOption<string>[] SubscriptionModeOptions = new[]
    {
new Select<string>.SelectOption<string>("Brackets", "Brackets"),
new Select<string>.SelectOption<string>("Incremental", "Incremental")
};

    protected override void OnInitialized()
    {
        SubConfigService.ConfigChanged += OnConfigChanged;
        foreach (var sec in SubConfigService.Config.Sections)
        {
            ExpandedSections.Add(sec.Id);
        }
    }

    private IEnumerable<ShockerInfo> GetLoadedShockers() => DeviceActions.GetLoadedShockers();

    private static int ParseInt(object? value, int defaultValue)
    {
        if (value == null) return defaultValue;
        return int.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static double ParseDouble(object? value, double defaultValue)
    {
        if (value == null) return defaultValue;
        return double.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static SelectionMode ParseSelectionMode(object? value)
    {
        if (value == null) return SelectionMode.All;
        return Enum.TryParse<SelectionMode>(value.ToString(), out var result) ? result : SelectionMode.All;
    }

    private static SubscriptionMode ParseSubscriptionMode(object? value)
    {
        if (value == null) return SubscriptionMode.Brackets;
        return Enum.TryParse<SubscriptionMode>(value.ToString(), out var result) ? result : SubscriptionMode.Brackets;
    }

    private void OnConfigChanged() => InvokeAsync(StateHasChanged);

    private void ToggleMasterEnabled(bool enabled) => SubConfigService.SetEnabled(enabled);

    private void ToggleSectionExpanded(string sectionId)
    {
        if (ExpandedSections.Contains(sectionId))
            ExpandedSections.Remove(sectionId);
        else
            ExpandedSections.Add(sectionId);
    }

    private void ToggleSectionEnabled(SubscriptionTierSection sec, bool enabled)
    {
        sec.Enabled = enabled;
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateSectionMode(SubscriptionTierSection sec, SubscriptionMode mode)
    {
        sec.Mode = mode;
        SubConfigService.UpdateSection(sec);
    }

    // Incremental action updates
    private void UpdateIncrementalBaseIntensity(SubscriptionTierSection sec, int value)
    {
        sec.Incremental.BaseIntensity = Math.Clamp(value, 1, 100);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalBaseDuration(SubscriptionTierSection sec, double value)
    {
        sec.Incremental.BaseDuration = Math.Clamp(value, 0.1, 15.0);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalMaxIntensity(SubscriptionTierSection sec, int value)
    {
        sec.Incremental.MaxIntensity = Math.Clamp(value, 1, 100);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalMaxDuration(SubscriptionTierSection sec, double value)
    {
        sec.Incremental.MaxDuration = Math.Clamp(value, 0.1, 15.0);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalIntensityIncrement(SubscriptionTierSection sec, int value)
    {
        sec.Incremental.IncrementIntensity = Math.Max(0, value);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalDurationIncrement(SubscriptionTierSection sec, double value)
    {
        sec.Incremental.IncrementDuration = Math.Max(0.0, value);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalMode(SubscriptionTierSection sec, SelectionMode mode)
    {
        sec.Incremental.Mode = mode;
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalCommandType(SubscriptionTierSection sec, string commandType)
    {
        sec.Incremental.CommandType = commandType;
        SubConfigService.UpdateSection(sec);
    }

    // Bracket updates
    private void UpdateSectionFixedAmount(SubscriptionTierSection sec, bool fixedAmount)
    {
        sec.FixedAmount = fixedAmount;
        SubConfigService.UpdateSection(sec);
    }

    private void AddBracket(SubscriptionTierSection sec)
    {
        var bracket = new SubscriptionBracket
        {
            Count = 1,
            Intensity = 50,
            Duration = 1.0,
            Mode = SelectionMode.All
        };
        sec.Brackets.Add(bracket);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketCount(SubscriptionTierSection sec, SubscriptionBracket bracket, int count)
    {
        bracket.Count = Math.Max(1, count);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketIntensity(SubscriptionTierSection sec, SubscriptionBracket bracket, int intensity)
    {
        bracket.Intensity = Math.Clamp(intensity, 1, 100);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketDuration(SubscriptionTierSection sec, SubscriptionBracket bracket, double duration)
    {
        bracket.Duration = Math.Clamp(duration, 0.1, 15.0);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketMode(SubscriptionTierSection sec, SubscriptionBracket bracket, SelectionMode mode)
    {
        bracket.Mode = mode;
        SubConfigService.UpdateSection(sec);
    }

    private void RemoveBracket(SubscriptionTierSection sec, SubscriptionBracket bracket)
    {
        sec.Brackets.RemoveAll(b => b.Id == bracket.Id);
        SubConfigService.UpdateSection(sec);
    }

    private void MoveBracket(SubscriptionTierSection sec, SubscriptionBracket bracket, int direction)
    {
        var index = sec.Brackets.FindIndex(b => b.Id == bracket.Id);
        if (index < 0) return;

        var newIndex = index + direction;
        if (newIndex < 0 || newIndex >= sec.Brackets.Count) return;

        (sec.Brackets[index], sec.Brackets[newIndex]) = (sec.Brackets[newIndex], sec.Brackets[index]);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketCommandType(SubscriptionTierSection sec, string commandType)
    {
        sec.BracketCommandType = commandType;
        SubConfigService.UpdateSection(sec);
    }

    private void ConvertFromCheerSection(SubscriptionTierSection sec)
    {
        var cheerSections = CheerConfigService?.Config.Sections;
        if (cheerSections == null || !cheerSections.Any()) return;

        var sourceId = SelectedCheerSectionIdForImport;
        var source = !string.IsNullOrEmpty(sourceId)
        ? cheerSections.FirstOrDefault(s => s.Id == sourceId)
        : cheerSections.FirstOrDefault();

        if (source == null || !source.Brackets.Any()) return;

        var bitsPerSub = sec.Tier switch
        {
            1 => 250,
            2 => 500,
            3 => 1250,
            _ => 250
        };

        if (bitsPerSub <= 0) return;

        var newBrackets = source.Brackets
        .OrderBy(b => b.BitAmount)
        .Select(b => new SubscriptionBracket
        {
            Count = Math.Max(1, (int)Math.Round((double)b.BitAmount / bitsPerSub)),
            Intensity = b.Intensity,
            Duration = b.Duration,
            Mode = b.Mode
        })
        .ToList();

        sec.Brackets = newBrackets;
        sec.BracketCommandType = source.CommandType;
        sec.FixedAmount = source.FixedAmount;

        SubConfigService.UpdateSection(sec);
    }

    public void Dispose()
    {
        SubConfigService.ConfigChanged -= OnConfigChanged;
    }
}