@page "/plugins/com-multishock-twitchintegration/sub-config"
@using MultiShock.PluginSdk
@inject SubscriptionConfigService SubConfigService
@inject CheerConfigService CheerConfigService
@inject IDeviceActions DeviceActions
@implements IDisposable

<div class="p-4 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold" style="color: var(--app-text, #e9ecef);">Subscriptions Configuration</h1>
            <p class="text-sm mt-1" style="color: var(--app-muted, #adb5bd);">Configure actions triggered by
                subscriptions and gifted subs</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-3 py-2 rounded-md"
                style="background: var(--app-surface, #1e1e1e); border: 1px solid var(--app-border, #343a40);">
                <input type="checkbox" class="twitch-toggle" checked="@SubConfigService.Config.Enabled"
                    @onchange="@((e) => ToggleMasterEnabled((bool)e.Value!))">
                <span class="text-sm font-medium"
                    style="color: @(SubConfigService.Config.Enabled ? "var(--app-primary, #4a9eff)" : "var(--app-muted, #adb5bd)");">
                    @(SubConfigService.Config.Enabled ? "Enabled" : "Disabled")
                </span>
            </div>
        </div>
    </div>

    <div class="space-y-3">
        @foreach (var sec in SubConfigService.Config.Sections.OrderBy(s => s.Tier))
        {
            <div class="twitch-card @(!sec.Enabled ? "opacity-50" : "")">
                <div class="twitch-card-header cursor-pointer hover:opacity-80"
                    @onclick="@(() => ToggleSectionExpanded(sec.Id))">
                    <div class="flex items-center gap-2">
                        <div @onclick:stopPropagation="true">
                            <input type="checkbox" class="twitch-toggle" checked="@sec.Enabled"
                                @onchange="@((e) => ToggleSectionEnabled(sec, (bool)e.Value!))">
                        </div>
                        <span>Tier @sec.Tier</span>
                        <span class="twitch-badge">@sec.SelectedShockerIds.Count shockers</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 transition-transform @(ExpandedSections.Contains(sec.Id) ? "rotate-180" : "")"
                            style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                </div>

                @if (ExpandedSections.Contains(sec.Id))
                {
                    <div class="twitch-card-body space-y-4">
                        <div class="flex flex-wrap items-end gap-2">
                            <div class="w-40">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Mode</label>
                                <select class="twitch-select w-full text-xs" value="@sec.Mode.ToString()"
                                    @onchange="@((e) => UpdateSectionMode(sec, ParseSubscriptionMode(e.Value)))">
                                    <option value="Brackets">Brackets</option>
                                    <option value="Incremental">Incremental</option>
                                </select>
                            </div>

                            <div class="grow">
                                <label class="block text-xs font-medium mb-1"
                                    style="color: var(--app-muted, #adb5bd);">Shockers</label>
                                @{
                                    var loadedShockers = GetLoadedShockers().ToList();
                                    var selectedCount = sec.SelectedShockerIds.Count;
                                }
                                @if (loadedShockers.Any())
                                {
                                    <div class="twitch-multiselect" @onclick="@(() => ToggleShockerDropdown(sec.Id))"
                                        @onclick:stopPropagation="true">
                                        <div class="twitch-multiselect-display">
                                            @if (selectedCount == 0)
                                            {
                                                <span style="color: var(--app-muted, #adb5bd);">Select...</span>
                                            }
                                            else if (selectedCount == loadedShockers.Count)
                                            {
                                                <span>All (@selectedCount)</span>
                                            }
                                            else
                                            {
                                                <span>@selectedCount selected</span>
                                            }
                                            <svg class="w-3 h-3 transition-transform @(OpenShockerDropdown == sec.Id ? "rotate-180" : "")"
                                                style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </div>
                                        @if (OpenShockerDropdown == sec.Id)
                                        {
                                            <div class="twitch-multiselect-dropdown">
                                                <div class="twitch-multiselect-actions">
                                                    <button type="button" class="text-xs" style="color: var(--app-primary, #4a9eff);"
                                                        @onclick="@(() => SelectAllShockers(sec, loadedShockers))"
                                                        @onclick:stopPropagation="true">
                                                        All
                                                    </button>
                                                    <button type="button" class="text-xs" style="color: var(--app-muted, #adb5bd);"
                                                        @onclick="@(() => ClearAllShockers(sec))" @onclick:stopPropagation="true">
                                                        Clear
                                                    </button>
                                                </div>
                                                @foreach (var shocker in loadedShockers)
                                                {
                                                    var combinedId = $"{shocker.DeviceId}:{shocker.ShockerId}";
                                                    var isSelected = sec.SelectedShockerIds.Contains(combinedId);
                                                    <label class="twitch-multiselect-option @(isSelected ? "selected" : "")"
                                                        @onclick:stopPropagation="true">
                                                        <input type="checkbox" checked="@isSelected" class="twitch-checkbox"
                                                            @onchange="@(() => ToggleShockerSelection(sec, combinedId))">
                                                        <span>@shocker.Name</span>
                                                    </label>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="twitch-input w-full flex items-center text-xs"
                                        style="color: var(--app-muted, #adb5bd);">
                                        No shockers
                                    </div>
                                }
                            </div>
                        </div>
                        @if (sec.Mode == SubscriptionMode.Brackets)
                        {
                            <div class="pt-3" style="border-top: 1px solid var(--app-border, #343a40);">
                                <div class="flex flex-wrap items-end gap-3 mb-3">
                                    <div class="grow">
                                        <label class="block text-xs font-medium mb-1"
                                            style="color: var(--app-muted, #adb5bd);">Command Type</label>
                                        <select class="twitch-select w-full text-xs" value="@sec.BracketCommandType"
                                            @onchange="@((e) => UpdateBracketCommandType(sec, e.Value?.ToString() ?? "Vibrate"))">
                                            <option value="Shock">Shock</option>
                                            <option value="Vibrate">Vibrate</option>
                                            <option value="Beep">Beep</option>
                                        </select>
                                    </div>
                                    <div class="w-40">
                                        <label class="block text-xs font-medium mb-1"
                                            style="color: var(--app-muted, #adb5bd);">Matching</label>
                                        <select class="twitch-select w-full text-xs" value="@(sec.FixedAmount ? "exact" : "round")"
                                            @onchange="@((e) => UpdateSectionFixedAmount(sec, e.Value?.ToString() == "exact"))">
                                            <option value="round">Round Down</option>
                                            <option value="exact">Exact</option>
                                        </select>
                                    </div>
                                    <button class="twitch-btn twitch-btn-secondary twitch-btn-sm" type="button"
                                        @onclick="@(() => AddBracket(sec))">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4" />
                                        </svg>
                                        Add Bracket
                                    </button>
                                    @if (CheerConfigService.Config.Sections.Any())
                                    {
                                        <div class="flex items-end gap-2">
                                            <div>
                                                <label class="block text-xs font-medium mb-1"
                                                    style="color: var(--app-muted, #adb5bd);">Import from Cheers</label>
                                                <select class="twitch-select w-40 text-xs" value="@SelectedCheerSectionIdForImport"
                                                    @onchange="@((e) => SelectedCheerSectionIdForImport = e.Value?.ToString())">
                                                    @foreach (var cheerSection in CheerConfigService.Config.Sections)
                                                    {
                                                        <option value="@cheerSection.Id">@cheerSection.Name</option>
                                                    }
                                                </select>
                                            </div>
                                            <button class="twitch-btn twitch-btn-secondary twitch-btn-sm" type="button"
                                                @onclick="@(() => ConvertFromCheerSection(sec))">
                                                Convert
                                            </button>
                                        </div>
                                    }
                                </div>

                                <div class="space-y-2">
                                    @if (sec.Brackets.Any())
                                    {
                                        <div class="twitch-bracket-header">
                                            <span class="w-12"></span>
                                            <span class="w-20">Subs</span>
                                            <span class="flex-1">Intensity</span>
                                            <span class="flex-1">Duration</span>
                                            <span class="w-28">Mode</span>
                                            <span class="w-8"></span>
                                        </div>
                                    }
                                    @{
                                        var orderedBrackets = sec.Brackets.OrderBy(b => b.Count).ToList();
                                    }
                                    @foreach (var bracket in orderedBrackets)
                                    {
                                        <div class="twitch-bracket">
                                            <div class="flex gap-1 w-12">
                                                <button type="button" class="twitch-reorder-btn" title="Move Up"
                                                    disabled="@(orderedBrackets.IndexOf(bracket) == 0)"
                                                    @onclick="@(() => MoveBracket(sec, bracket, -1))">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                            d="M5 15l7-7 7 7" />
                                                    </svg>
                                                </button>
                                                <button type="button" class="twitch-reorder-btn" title="Move Down"
                                                    disabled="@(orderedBrackets.IndexOf(bracket) == orderedBrackets.Count - 1)"
                                                    @onclick="@(() => MoveBracket(sec, bracket, 1))">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                            d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div class="w-20">
                                                <input type="number" class="twitch-input w-full text-center font-mono" min="1"
                                                    value="@bracket.Count"
                                                    @onchange="@((e) => UpdateBracketCount(sec, bracket, ParseInt(e.Value, 1)))">
                                            </div>

                                            <div class="flex items-center gap-2 flex-1">
                                                <input type="range" class="twitch-slider" style="flex: 1 1 0; min-width: 0;" min="1"
                                                    max="100" value="@bracket.Intensity"
                                                    @oninput="@((e) => UpdateBracketIntensity(sec, bracket, ParseInt(e.Value, 50)))">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem; flex-shrink: 0;" min="1" max="100" value="@bracket.Intensity"
                                                    @onchange="@((e) => UpdateBracketIntensity(sec, bracket, Math.Clamp(ParseInt(e.Value, 50), 1, 100)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd); flex-shrink: 0;">%</span>
                                            </div>

                                            <div class="flex items-center gap-2 flex-1">
                                                <input type="range" class="twitch-slider" style="flex: 1 1 0; min-width: 0;" min="0.1"
                                                    max="15" step="0.1" value="@bracket.Duration"
                                                    @oninput="@((e) => UpdateBracketDuration(sec, bracket, ParseDouble(e.Value, 1.0)))">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem; flex-shrink: 0;" min="0.1" max="15" step="0.1"
                                                    value="@bracket.Duration.ToString("0.0")"
                                                    @onchange="@((e) => UpdateBracketDuration(sec, bracket, Math.Clamp(ParseDouble(e.Value, 1.0), 0.1, 15.0)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd); flex-shrink: 0;">s</span>
                                            </div>

                                            <div class="w-28">
                                                <select class="twitch-select w-full text-xs" value="@bracket.Mode.ToString()"
                                                    @onchange="@((e) => UpdateBracketMode(sec, bracket, ParseSelectionMode(e.Value)))">
                                                    <option value="All">All</option>
                                                    <option value="Random">Random</option>
                                                    <option value="RoundRobin">Round Robin</option>
                                                </select>
                                            </div>

                                            <button type="button" class="twitch-toolbar-btn danger" title="Delete Bracket"
                                                @onclick="@(() => RemoveBracket(sec, bracket))">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>
                                    }
                                    @if (!sec.Brackets.Any())
                                    {
                                        <div class="twitch-empty">
                                            <p>No brackets configured</p>
                                            <p class="text-xs">Add a bracket to define behavior at different sub counts</p>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (sec.Mode == SubscriptionMode.Incremental)
                        {
                            <div class="pt-3" style="border-top: 1px solid var(--app-border, #343a40);">
                                <div class="flex items-center justify-between mb-2">
                                    <div>
                                        <label class="text-sm font-medium" style="color: var(--app-text, #e9ecef);">Incremental
                                            Subs</label>
                                        <p class="text-xs mt-0.5" style="color: var(--app-muted, #adb5bd);">
                                            Base values apply to 1 sub. Each additional sub (including gifts) increases intensity
                                            and duration by the increment values, up to the max.
                                        </p>
                                    </div>
                                </div>

                                <div class="space-y-2 mb-3">
                                    <div class="flex flex-wrap items-start gap-3">
                                        <span class="text-xs font-semibold"
                                            style="color: var(--app-muted, #adb5bd); min-width: 4rem; padding-top: 0.35rem;">Intensity</span>
                                        <div class="flex-1 min-w-0 space-y-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Base</span>
                                                <input type="range" class="twitch-slider" min="1" max="100"
                                                    value="@sec.Incremental.BaseIntensity"
                                                    @oninput="@((e) => UpdateIncrementalBaseIntensity(sec, ParseInt(e.Value, 50)))">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem;" min="1" max="100" value="@sec.Incremental.BaseIntensity"
                                                    @onchange="@((e) => UpdateIncrementalBaseIntensity(sec, Math.Clamp(ParseInt(e.Value, 50), 1, 100)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Max</span>
                                                <input type="range" class="twitch-slider" min="1" max="100"
                                                    value="@sec.Incremental.MaxIntensity"
                                                    @oninput="@((e) => UpdateIncrementalMaxIntensity(sec, ParseInt(e.Value, 100)))">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem;" min="1" max="100" value="@sec.Incremental.MaxIntensity"
                                                    @onchange="@((e) => UpdateIncrementalMaxIntensity(sec, Math.Clamp(ParseInt(e.Value, 100), 1, 100)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-1">
                                            <span class="text-xs" style="color: var(--app-muted, #adb5bd);">+ /sub</span>
                                            <div class="flex items-center gap-2">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem;" min="0" max="100"
                                                    value="@sec.Incremental.IncrementIntensity"
                                                    @onchange="@((e) => UpdateIncrementalIntensityIncrement(sec, Math.Clamp(ParseInt(e.Value, 5), 0, 100)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex flex-wrap items-start gap-3">
                                        <span class="text-xs font-semibold"
                                            style="color: var(--app-muted, #adb5bd); min-width: 4rem; padding-top: 0.35rem;">Duration</span>
                                        <div class="flex-1 min-w-0 space-y-1">
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Base</span>
                                                <input type="range" class="twitch-slider" min="0.1" max="15" step="0.1"
                                                    value="@sec.Incremental.BaseDuration"
                                                    @oninput="@((e) => UpdateIncrementalBaseDuration(sec, ParseDouble(e.Value, 1.0)))">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem;" min="0.1" max="15" step="0.1"
                                                    value="@sec.Incremental.BaseDuration.ToString("0.0")"
                                                    @onchange="@((e) => UpdateIncrementalBaseDuration(sec, Math.Clamp(ParseDouble(e.Value, 1.0), 0.1, 15.0)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Max</span>
                                                <input type="range" class="twitch-slider" min="0.1" max="15" step="0.1"
                                                    value="@sec.Incremental.MaxDuration"
                                                    @oninput="@((e) => UpdateIncrementalMaxDuration(sec, ParseDouble(e.Value, 5.0)))">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem;" min="0.1" max="15" step="0.1"
                                                    value="@sec.Incremental.MaxDuration.ToString("0.0")"
                                                    @onchange="@((e) => UpdateIncrementalMaxDuration(sec, Math.Clamp(ParseDouble(e.Value, 5.0), 0.1, 15.0)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-1">
                                            <span class="text-xs" style="color: var(--app-muted, #adb5bd);">+ /sub</span>
                                            <div class="flex items-center gap-2">
                                                <input type="number" class="twitch-input text-center text-xs font-mono"
                                                    style="width: 4rem;" min="0" max="15" step="0.1"
                                                    value="@sec.Incremental.IncrementDuration.ToString("0.0")"
                                                    @onchange="@((e) => UpdateIncrementalDurationIncrement(sec, Math.Clamp(ParseDouble(e.Value, 0.5), 0.0, 15.0)))">
                                                <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-2">
                                    <span class="text-xs font-semibold" style="color: var(--app-muted, #adb5bd);">Mode / Type</span>
                                    <div class="flex flex-col gap-1">
                                        <span class="text-xs" style="color: var(--app-muted, #adb5bd);">Mode &amp; Command</span>
                                        <div class="flex gap-2">
                                            <select class="twitch-select flex-1 text-xs" value="@sec.Incremental.Mode.ToString()"
                                                @onchange="@((e) => UpdateIncrementalMode(sec, ParseSelectionMode(e.Value)))">
                                                <option value="All">All</option>
                                                <option value="Random">Random</option>
                                                <option value="RoundRobin">Round Robin</option>
                                            </select>
                                            <select class="twitch-select flex-1 text-xs" value="@sec.Incremental.CommandType"
                                                @onchange="@((e) => UpdateIncrementalCommandType(sec, e.Value?.ToString() ?? "Vibrate"))">
                                                <option value="Shock">Shock</option>
                                                <option value="Vibrate">Vibrate</option>
                                                <option value="Beep">Beep</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

                @if (!SubConfigService.Config.Sections.Any())
                {
                    <div class="twitch-card">
                        <div class="twitch-card-body">
                            <div class="twitch-empty py-8">
                                <p>No subscription tiers configured</p>
                                <p class="text-xs" style="color: var(--app-muted, #adb5bd);">This plugin normally creates one
                                    section per tier automatically.</p>
                            </div>
                        </div>
                    </div>
                }

                <div class="twitch-card">
                    <div class="twitch-card-header cursor-pointer" @onclick="@(() => ShowHelpCard = !ShowHelpCard)">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4" style="color: var(--app-primary, #4a9eff);" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span>How It Works</span>
                        </div>
                        <svg class="w-4 h-4 transition-transform @(ShowHelpCard ? "rotate-180" : "")"
                            style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    @if (ShowHelpCard)
                    {
                        <div class="twitch-card-body text-sm" style="color: var(--app-muted, #adb5bd);">
                            <p class="mb-2">When a subscription event arrives, the matching tier section is used.</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>In <strong>Brackets</strong> mode, subs use the matching bracket based on sub count (1 for
                                    single, gift count for gifts).</li>
                                <li>In <strong>Incremental</strong> mode, both single subs and gifts use the incremental scaling
                                    based on sub count.</li>
                            </ul>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>
@code {
    private HashSet<string> ExpandedSections = new();
    private string? OpenShockerDropdown = null;
    private bool ShowHelpCard = false;
    private string? SelectedCheerSectionIdForImport;

    protected override void OnInitialized()
    {
        SubConfigService.ConfigChanged += OnConfigChanged;
        foreach (var sec in SubConfigService.Config.Sections)
        {
            ExpandedSections.Add(sec.Id);
        }
    }

    private IEnumerable<ShockerInfo> GetLoadedShockers() => DeviceActions.GetLoadedShockers();

    private static int ParseInt(object? value, int defaultValue)
    {
        if (value == null) return defaultValue;
        return int.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static double ParseDouble(object? value, double defaultValue)
    {
        if (value == null) return defaultValue;
        return double.TryParse(value.ToString(), out var result) ? result : defaultValue;
    }

    private static SelectionMode ParseSelectionMode(object? value)
    {
        if (value == null) return SelectionMode.All;
        return Enum.TryParse<SelectionMode>(value.ToString(), out var result) ? result : SelectionMode.All;
    }

    private static SubscriptionMode ParseSubscriptionMode(object? value)
    {
        if (value == null) return SubscriptionMode.Brackets;
        return Enum.TryParse<SubscriptionMode>(value.ToString(), out var result) ? result : SubscriptionMode.Brackets;
    }

    private void OnConfigChanged() => InvokeAsync(StateHasChanged);

    private void ToggleMasterEnabled(bool enabled) => SubConfigService.SetEnabled(enabled);

    private void ToggleSectionExpanded(string sectionId)
    {
        if (ExpandedSections.Contains(sectionId))
            ExpandedSections.Remove(sectionId);
        else
            ExpandedSections.Add(sectionId);
    }

    private void ToggleShockerDropdown(string sectionId)
    {
        OpenShockerDropdown = OpenShockerDropdown == sectionId ? null : sectionId;
    }

    private void SelectAllShockers(SubscriptionTierSection sec, List<ShockerInfo> shockers)
    {
        foreach (var shocker in shockers)
        {
            var combinedId = $"{shocker.DeviceId}:{shocker.ShockerId}";
            if (!sec.SelectedShockerIds.Contains(combinedId))
                sec.SelectedShockerIds.Add(combinedId);
        }
        SubConfigService.UpdateSection(sec);
    }

    private void ClearAllShockers(SubscriptionTierSection sec)
    {
        sec.SelectedShockerIds.Clear();
        SubConfigService.UpdateSection(sec);
    }

    private void ToggleSectionEnabled(SubscriptionTierSection sec, bool enabled)
    {
        sec.Enabled = enabled;
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateSectionMode(SubscriptionTierSection sec, SubscriptionMode mode)
    {
        sec.Mode = mode;
        SubConfigService.UpdateSection(sec);
    }

    private void ToggleShockerSelection(SubscriptionTierSection sec, string shockerId)
    {
        if (sec.SelectedShockerIds.Contains(shockerId))
            sec.SelectedShockerIds.Remove(shockerId);
        else
            sec.SelectedShockerIds.Add(shockerId);
        SubConfigService.UpdateSection(sec);
    }
    // Incremental action updates
    private void UpdateIncrementalBaseIntensity(SubscriptionTierSection sec, int value)
    {
        sec.Incremental.BaseIntensity = Math.Clamp(value, 1, 100);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalBaseDuration(SubscriptionTierSection sec, double value)
    {
        sec.Incremental.BaseDuration = Math.Clamp(value, 0.1, 15.0);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalMaxIntensity(SubscriptionTierSection sec, int value)
    {
        sec.Incremental.MaxIntensity = Math.Clamp(value, 1, 100);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalMaxDuration(SubscriptionTierSection sec, double value)
    {
        sec.Incremental.MaxDuration = Math.Clamp(value, 0.1, 15.0);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalIntensityIncrement(SubscriptionTierSection sec, int value)
    {
        sec.Incremental.IncrementIntensity = Math.Max(0, value);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalDurationIncrement(SubscriptionTierSection sec, double value)
    {
        sec.Incremental.IncrementDuration = Math.Max(0.0, value);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalMode(SubscriptionTierSection sec, SelectionMode mode)
    {
        sec.Incremental.Mode = mode;
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateIncrementalCommandType(SubscriptionTierSection sec, string commandType)
    {
        sec.Incremental.CommandType = commandType;
        SubConfigService.UpdateSection(sec);
    }

    // Bracket updates
    private void UpdateSectionFixedAmount(SubscriptionTierSection sec, bool fixedAmount)
    {
        sec.FixedAmount = fixedAmount;
        SubConfigService.UpdateSection(sec);
    }

    private void AddBracket(SubscriptionTierSection sec)
    {
        var bracket = new SubscriptionBracket
        {
            Count = 1,
            Intensity = 50,
            Duration = 1.0,
            Mode = SelectionMode.All
        };
        sec.Brackets.Add(bracket);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketCount(SubscriptionTierSection sec, SubscriptionBracket bracket, int count)
    {
        bracket.Count = Math.Max(1, count);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketIntensity(SubscriptionTierSection sec, SubscriptionBracket bracket, int intensity)
    {
        bracket.Intensity = Math.Clamp(intensity, 1, 100);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketDuration(SubscriptionTierSection sec, SubscriptionBracket bracket, double duration)
    {
        bracket.Duration = Math.Clamp(duration, 0.1, 15.0);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketMode(SubscriptionTierSection sec, SubscriptionBracket bracket, SelectionMode mode)
    {
        bracket.Mode = mode;
        SubConfigService.UpdateSection(sec);
    }

    private void RemoveBracket(SubscriptionTierSection sec, SubscriptionBracket bracket)
    {
        sec.Brackets.RemoveAll(b => b.Id == bracket.Id);
        SubConfigService.UpdateSection(sec);
    }

    private void MoveBracket(SubscriptionTierSection sec, SubscriptionBracket bracket, int direction)
    {
        var index = sec.Brackets.FindIndex(b => b.Id == bracket.Id);
        if (index < 0) return;

        var newIndex = index + direction;
        if (newIndex < 0 || newIndex >= sec.Brackets.Count) return;

        (sec.Brackets[index], sec.Brackets[newIndex]) = (sec.Brackets[newIndex], sec.Brackets[index]);
        SubConfigService.UpdateSection(sec);
    }

    private void UpdateBracketCommandType(SubscriptionTierSection sec, string commandType)
    {
        sec.BracketCommandType = commandType;
        SubConfigService.UpdateSection(sec);
    }

    private void ConvertFromCheerSection(SubscriptionTierSection sec)
    {
        var cheerSections = CheerConfigService?.Config.Sections;
        if (cheerSections == null || !cheerSections.Any()) return;

        var sourceId = SelectedCheerSectionIdForImport;
        var source = !string.IsNullOrEmpty(sourceId)
        ? cheerSections.FirstOrDefault(s => s.Id == sourceId)
        : cheerSections.FirstOrDefault();

        if (source == null || !source.Brackets.Any()) return;

        var bitsPerSub = sec.Tier switch
        {
            1 => 250,
            2 => 500,
            3 => 1250,
            _ => 250
        };

        if (bitsPerSub <= 0) return;

        var newBrackets = source.Brackets
        .OrderBy(b => b.BitAmount)
        .Select(b => new SubscriptionBracket
        {
            Count = Math.Max(1, (int)Math.Round((double)b.BitAmount / bitsPerSub)),
            Intensity = b.Intensity,
            Duration = b.Duration,
            Mode = b.Mode
        })
        .ToList();

        sec.Brackets = newBrackets;
        sec.BracketCommandType = source.CommandType;
        sec.FixedAmount = source.FixedAmount;

        SubConfigService.UpdateSection(sec);
    }

    public void Dispose()
    {
        SubConfigService.ConfigChanged -= OnConfigChanged;
    }
}