<Project Sdk="Microsoft.NET.Sdk.Razor">
    <PropertyGroup>
        <TargetFramework>net10.0</TargetFramework>
        <Nullable>enable</Nullable>
        <ImplicitUsings>enable</ImplicitUsings>
        
        <AssemblyName>ImageDetectionPlugin</AssemblyName>
        <RootNamespace>ImageDetectionPlugin</RootNamespace>
        
        <RazorLangVersion>Latest</RazorLangVersion>
        <PluginBuildStamp>$([System.DateTime]::UtcNow.ToString("yyyyMMddHHmmss"))</PluginBuildStamp>
    </PropertyGroup>

    <!-- Release optimizations -->
    <PropertyGroup Condition="'$(Configuration)'=='Release'">
        <SatelliteResourceLanguages>en</SatelliteResourceLanguages>
        <InvariantGlobalization>true</InvariantGlobalization>
    </PropertyGroup>

    <!-- Dependencies -->
    <ItemGroup>
        <PackageReference Include="Emgu.CV" Version="4.12.0.5764" />
        <PackageReference Include="Microsoft.AspNetCore.Components" Version="9.0.0" />
        <PackageReference Include="Microsoft.AspNetCore.Components.Web" Version="9.0.0" />
    </ItemGroup>

    <ItemGroup>
        <Reference Include="MultiShock.PluginSdk">
            <HintPath>..\..\Dependencies\MultiShock.PluginSdk.dll</HintPath>
            <Private>true</Private>
        </Reference>
    </ItemGroup>

    <!-- Version with build stamp -->
    <PropertyGroup>
        <AssemblyInformationalVersion>1.0.0+$(PluginBuildStamp)</AssemblyInformationalVersion>
    </PropertyGroup>

    <!-- Exclude generated file from default compilation -->
    <ItemGroup>
        <Compile Remove="Generated\BuildStamp.g.cs" />
    </ItemGroup>

    <!-- Generate build stamp for runtime version display -->
    <Target Name="GenerateBuildStamp" BeforeTargets="BeforeCompile">
        <MakeDir Directories="$(MSBuildProjectDirectory)\Generated" />
        <ItemGroup>
        <StampLines Include="namespace ImageDetectionPlugin%3B" />
        <StampLines Include=" " />
        <StampLines Include="public static class BuildStamp" />
        <StampLines Include="{" />
        <StampLines Include="    public const string Stamp = &quot;$(PluginBuildStamp)&quot;%3B" />
        <StampLines Include="}" />
        </ItemGroup>
        <WriteLinesToFile File="$(MSBuildProjectDirectory)\Generated\BuildStamp.g.cs" Lines="@(StampLines)" Overwrite="true" />
        <ItemGroup>
        <Compile Include="Generated\BuildStamp.g.cs" />
        </ItemGroup>
    </Target>
    <Target Name="CopyPluginToLocalAppData" AfterTargets="Build">
        <PropertyGroup>
        <LocalPluginDir>$(LOCALAPPDATA)\PiShock\MultiShock\Plugins</LocalPluginDir>
        </PropertyGroup>
        <MakeDir Directories="$(LocalPluginDir)" />
        <Copy SourceFiles="$(TargetPath)" DestinationFolder="$(LocalPluginDir)" />
        <Message Importance="High" Text="Copied plugin to $(LocalPluginDir)\$(TargetFileName)" />
    </Target>
</Project>
