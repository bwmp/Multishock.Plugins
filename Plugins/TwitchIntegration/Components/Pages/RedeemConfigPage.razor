@page "/plugins/com-multishock-twitchintegration/redeem-config"
@using MultiShock.PluginSdk
@inject IDeviceActions DeviceActions
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="p-4 mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-xl font-bold" style="color: var(--app-text, #e9ecef);">Channel Point Redemptions</h1>
            <p class="text-sm mt-1" style="color: var(--app-muted, #adb5bd);">Configure actions triggered by channel
                point redemptions</p>
        </div>
        <div class="flex items-center gap-3">
            <Toggle Label="@(RedeemConfigService.Config.Enabled ? "Enabled" : "Disabled")"
                Value="RedeemConfigService.Config.Enabled" ValueChanged="@((value) => ToggleMasterEnabled(value))" />
            <Button Text="Fetch Rewards" Variant="secondary" Disabled="@RedeemConfigService.IsFetchingRedeems"
                OnClick="@(() => FetchRewards())">
                @if (RedeemConfigService.IsFetchingRedeems)
                {
                    <LucideIcon Name="refresh-cw" Class="w-4 h-4 animate-spin" />
                }
                else
                {
                    <LucideIcon Name="refresh-cw" Class="w-4 h-4" />
                }
            </Button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(StatusMessage))
    {
        <div class="mb-4 text-sm px-4 py-3 rounded"
            style="background: @(StatusIsSuccess ? "rgba(74, 158, 255, 0.1)" : "rgba(220, 38, 38, 0.1)"); color: @(StatusIsSuccess ? "#4a9eff" : "#f87171");">
            @StatusMessage
        </div>
    }

    <!-- Tab Navigation -->
    <div class="flex gap-2 mb-4 border-b" style="border-color: var(--app-border, #495057);">
        <button @onclick="@(() => ActiveTab = "all")"
            class="px-4 py-2 text-sm font-medium transition-colors @(ActiveTab == "all" ? "border-b-2" : "")"
            style="color: @(ActiveTab == "all" ? "var(--app-primary, #4a9eff)" : "var(--app-muted, #adb5bd)"); border-color: var(--app-primary, #4a9eff);">
            All Rewards (@RedeemConfigService.Config.Redeems.Count)
        </button>
        <button @onclick="@(() => ActiveTab = "manageable")"
            class="px-4 py-2 text-sm font-medium transition-colors @(ActiveTab == "manageable" ? "border-b-2" : "")"
            style="color: @(ActiveTab == "manageable" ? "var(--app-primary, #4a9eff)" : "var(--app-muted, #adb5bd)"); border-color: var(--app-primary, #4a9eff);">
            Manageable (@RedeemConfigService.Config.Redeems.Count(r => r.IsManageable))
        </button>
    </div>

    <div class="space-y-3">
        @if (ActiveTab == "manageable")
        {
            <!-- Create New Reward Button -->
            <div class="twitch-card">
                <div class="twitch-card-body">
                    @if (!ShowCreateForm)
                    {
                        <Button Text="Create New Reward" Variant="primary" OnClick="@(() => ShowCreateForm = true)">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </Button>
                    }
                    else
                    {
                        <div class="space-y-3">
                            <h3 class="font-medium" style="color: var(--app-text, #e9ecef);">Create New Reward</h3>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">Title</label>
                                <input type="text" @bind="NewRewardTitle" class="twitch-input w-full" placeholder="Reward title" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">Cost (Channel Points)</label>
                                <input type="number" @bind="NewRewardCost" class="twitch-input w-full" min="1" placeholder="100" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">Description (Optional)</label>
                                <textarea @bind="NewRewardPrompt" class="twitch-input w-full" rows="2" placeholder="What does this reward do?"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <Button Text="Create" Variant="primary" Disabled="@IsCreatingReward" OnClick="@CreateReward" />
                                <Button Text="Cancel" Variant="secondary" OnClick="@(() => { ShowCreateForm = false; ResetCreateForm(); })" />
                            </div>
                        </div>
                    }
                </div>
            </div>

            var manageableRewards = RedeemConfigService.Config.Redeems.Where(r => r.IsManageable).OrderBy(r => r.RewardTitle).ToList();

            @if (manageableRewards.Any())
            {
                @foreach (var redeem in manageableRewards)
                {
                    @RenderRedeemCard(redeem, true)
                }
            }
            else
            {
                <div class="twitch-card">
                    <div class="twitch-card-body">
                        <div class="twitch-empty py-8">
                            <svg class="w-12 h-12 mb-2" style="color: var(--app-muted, #adb5bd);" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p>No manageable rewards</p>
                            <p class="text-xs mt-1" style="color: var(--app-muted, #adb5bd);">
                                Create rewards through this plugin to manage them here
                            </p>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            @if (RedeemConfigService.Config.Redeems.Any())
            {
                @foreach (var redeem in RedeemConfigService.Config.Redeems.OrderBy(r => r.RewardTitle))
                {
                    @RenderRedeemCard(redeem, false)
                }
            }
            else
            {
                <div class="twitch-card">
                    <div class="twitch-card-body">
                        <div class="twitch-empty py-8">
                            <svg class="w-12 h-12 mb-2" style="color: var(--app-muted, #adb5bd);" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p>No channel point rewards found</p>
                            <p class="text-xs mt-1" style="color: var(--app-muted, #adb5bd);">
                                Click "Fetch Rewards" to load your channel point rewards from Twitch
                            </p>
                            <Button Text="Fetch Rewards" Variant="primary" Class="mt-4"
                                Disabled="@RedeemConfigService.IsFetchingRedeems" OnClick="@(() => FetchRewards())" />
                        </div>
                    </div>
                </div>
            }
        }

        @if (RedeemConfigService.Config.LastFetchedUtc.HasValue)
        {
            <div class="text-xs text-center" style="color: var(--app-muted, #adb5bd);">
                Last fetched: @RedeemConfigService.Config.LastFetchedUtc.Value.ToLocalTime().ToString("g")
            </div>
        }

        <div class="twitch-card">
            <div class="twitch-card-header cursor-pointer" @onclick="@(() => ShowHelpCard = !ShowHelpCard)">
                <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" style="color: var(--app-primary, #4a9eff);" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>How It Works</span>
                </div>
                <svg class="w-4 h-4 transition-transform @(ShowHelpCard ? "rotate-180" : "")"
                    style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
            @if (ShowHelpCard)
            {
                <div class="twitch-card-body text-sm" style="color: var(--app-muted, #adb5bd);">
                    <p class="mb-2">Channel point redemptions trigger actions when viewers redeem custom rewards on your
                        channel.</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Click "Fetch Rewards" to load your channel point rewards from Twitch</li>
                        <li><strong>Manageable tab:</strong> Create and fully manage rewards through this plugin</li>
                        <li><strong>All Rewards tab:</strong> Configure actions for any reward (can't enable/disable externally created rewards)</li>
                        <li>Each reward can have different intensity, duration, and shocker selections</li>
                        <li>Only rewards created through this plugin can be enabled/disable via the SetRedeemEnabled node</li>
                    </ul>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // Use service locator instead of @inject for plugin-specific services
    // This survives hot-reload where the DI container has stale types
    private static readonly string PluginId = TwitchIntegrationPlugin.PluginId;
    private RedeemConfigService RedeemConfigService => PluginServiceLocator.GetRequiredService<RedeemConfigService>(PluginId);
    
    private string ActiveTab = "all";
    private HashSet<string> ExpandedRedeems = new();
    private bool ShowHelpCard = false;
    private string? StatusMessage;
    private bool StatusIsSuccess;

    // Create form state
    private bool ShowCreateForm = false;
    private bool IsCreatingReward = false;
    private string NewRewardTitle = "";
    private int NewRewardCost = 100;
    private string NewRewardPrompt = "";

    // Edit form state
    private string? EditingRewardId = null;
    private string EditRewardTitle = "";
    private int EditRewardCost = 100;
    private string EditRewardPrompt = "";

    private readonly Select<string>.SelectOption<string>[] SelectionModeOptions = new[]
    {
        new Select<string>.SelectOption<string>("All", "All"),
        new Select<string>.SelectOption<string>("Random", "Random"),
        new Select<string>.SelectOption<string>("RoundRobin", "Round Robin"),
    };

    private readonly Select<string>.SelectOption<string>[] CommandTypeOptions = new[]
    {
        new Select<string>.SelectOption<string>("Shock", "Shock"),
        new Select<string>.SelectOption<string>("Vibrate", "Vibrate"),
        new Select<string>.SelectOption<string>("Beep", "Beep"),
    };

    protected override void OnInitialized()
    {
        RedeemConfigService.ConfigChanged += OnConfigChanged;
        foreach (var redeem in RedeemConfigService.Config.Redeems)
        {
            ExpandedRedeems.Add(redeem.Id);
        }
    }

    private RenderFragment RenderRedeemCard(RedeemConfig redeem, bool isManageable) => __builder =>
    {
        var isEditing = EditingRewardId == redeem.RewardId;

        <div class="twitch-card @(!redeem.Enabled ? "opacity-50" : "")">
            <div class="twitch-card-header cursor-pointer hover:opacity-80"
                @onclick="@(() => ToggleExpanded(redeem.Id))">
                <div class="flex items-center gap-2">
                    <div @onclick:stopPropagation="true">
                        <Toggle Value="redeem.Enabled" ValueChanged="@((e) => ToggleRedeemEnabled(redeem, e))" />
                    </div>
                    <span>@redeem.RewardTitle</span>
                    <span class="twitch-badge twitch-badge-primary">@redeem.Cost pts</span>
                    <span class="twitch-badge">@redeem.CommandType</span>
                    @if (redeem.IsManageable)
                    {
                        <span class="twitch-badge" style="background: rgba(74, 158, 255, 0.2); color: #4a9eff;">Manageable</span>
                    }
                </div>
                <div class="flex items-center gap-2">
                    @if (redeem.SelectedShockerIds.Any())
                    {
                        <span class="twitch-badge">@redeem.SelectedShockerIds.Count shocker@(redeem.SelectedShockerIds.Count == 1 ? "" : "s")</span>
                    }
                    <svg class="w-4 h-4 transition-transform @(ExpandedRedeems.Contains(redeem.Id) ? "rotate-180" : "")"
                        style="color: var(--app-muted, #adb5bd);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </div>

            @if (ExpandedRedeems.Contains(redeem.Id))
            {
                <div class="twitch-card-body space-y-4">
                    @if (isManageable && isEditing)
                    {
                        <!-- Edit Form -->
                        <div class="space-y-3 p-3 rounded" style="background: rgba(74, 158, 255, 0.05);">
                            <h4 class="text-sm font-medium" style="color: var(--app-text, #e9ecef);">Edit Reward on Twitch</h4>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">Title</label>
                                <input type="text" @bind="EditRewardTitle" class="twitch-input w-full" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">Cost</label>
                                <input type="number" @bind="EditRewardCost" class="twitch-input w-full" min="1" />
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--app-muted, #adb5bd);">Description</label>
                                <textarea @bind="EditRewardPrompt" class="twitch-input w-full" rows="2"></textarea>
                            </div>
                            <div class="flex gap-2">
                                <Button Text="Save Changes" Variant="primary" OnClick="@(() => SaveRewardEdit(redeem.RewardId))" />
                                <Button Text="Cancel" Variant="secondary" OnClick="@(() => EditingRewardId = null)" />
                            </div>
                        </div>
                    }

                    <div class="flex flex-wrap items-end gap-3">
                        <div class="grow">
                            <label class="block text-xs font-medium mb-1"
                                style="color: var(--app-muted, #adb5bd);">Shockers</label>
                            @{
                                var loadedShockers = GetLoadedShockers().ToList();
                            }
                            @if (loadedShockers.Any())
                            {
                                <ShockerSelect Label="" MultiSelect="true" SelectedIds="redeem.SelectedShockerIds"
                                    SelectedIdsChanged="@(async (ids) => { redeem.SelectedShockerIds = ids; RedeemConfigService.UpdateRedeem(redeem); await InvokeAsync(StateHasChanged); })" />
                            }
                            else
                            {
                                <div class="twitch-input w-full flex items-center text-xs"
                                    style="color: var(--app-muted, #adb5bd);">
                                    No shockers
                                </div>
                            }
                        </div>
                        <div class="w-40">
                            <Select Label="Mode" Value="@redeem.Mode.ToString()"
                                ValueChanged="@((string value) => UpdateMode(redeem, ParseSelectionMode(value)))"
                                Options="@SelectionModeOptions" />
                        </div>
                        <div class="w-40">
                            <Select Label="Device Command" Value="@redeem.CommandType"
                                ValueChanged="@((string value) => UpdateCommandType(redeem, value ?? "Shock"))"
                                Options="@CommandTypeOptions" />
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-medium"
                                style="color: var(--app-muted, #adb5bd); min-width: 5rem;">Intensity</span>
                            <Slider Min="1" Max="100" Value="redeem.Intensity"
                                ValueChanged="@(v => UpdateIntensity(redeem, (int)v))" Class="flex-1" ShowValue="false" />
                            <NumberInput Value="@((double)redeem.Intensity)" Min="1" Max="100"
                                ValueChanged="@(v => UpdateIntensity(redeem, (int)Math.Clamp(v ?? 50, 1, 100)))"
                                Class="w-16" />
                            <span class="text-xs" style="color: var(--app-muted, #adb5bd);">%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-medium"
                                style="color: var(--app-muted, #adb5bd); min-width: 5rem;">Duration</span>
                            <Slider Min="0.1" Max="15" Step="0.1" Value="redeem.Duration"
                                ValueChanged="@(v => UpdateDuration(redeem, v))" Class="flex-1" ShowValue="false" />
                            <NumberInput Value="redeem.Duration" Min="0.1" Max="15" Step="0.1"
                                ValueChanged="@(v => UpdateDuration(redeem, Math.Clamp(v ?? 1.0, 0.1, 15.0)))"
                                Class="w-16" />
                            <span class="text-xs" style="color: var(--app-muted, #adb5bd);">s</span>
                        </div>
                    </div>

                    @if (isManageable && !isEditing)
                    {
                        <div class="flex gap-2 pt-2 border-t" style="border-color: var(--app-border, #495057);">
                            <Button Text="Edit Reward" Variant="secondary" OnClick="@(() => StartEditReward(redeem))">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </Button>
                            <Button Text="Delete Reward" Variant="secondary" OnClick="@(() => DeleteReward(redeem.RewardId))"
                                Style="color: #f87171;">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </Button>
                        </div>
                    }
                    else if (!isManageable)
                    {
                        <div class="text-xs p-2 rounded" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <strong>Note:</strong> This reward was created outside this plugin and can only be configured for actions here. To enable/disable it via the SetRedeemEnabled node, create it through this plugin.
                        </div>
                    }
                </div>
            }
        </div>
    };

    private IEnumerable<ShockerInfo> GetLoadedShockers() => DeviceActions.GetLoadedShockers();

    private void OnConfigChanged() => InvokeAsync(StateHasChanged);

    private void ToggleMasterEnabled(bool enabled) => RedeemConfigService.SetEnabled(enabled);

    private void ToggleExpanded(string redeemId)
    {
        if (ExpandedRedeems.Contains(redeemId))
            ExpandedRedeems.Remove(redeemId);
        else
            ExpandedRedeems.Add(redeemId);
    }

    private void ToggleRedeemEnabled(RedeemConfig redeem, bool enabled)
    {
        RedeemConfigService.SetRedeemEnabled(redeem.Id, enabled);
    }

    private void UpdateIntensity(RedeemConfig redeem, int value)
    {
        RedeemConfigService.UpdateRedeemIntensity(redeem.Id, value);
    }

    private void UpdateDuration(RedeemConfig redeem, double value)
    {
        RedeemConfigService.UpdateRedeemDuration(redeem.Id, value);
    }

    private void UpdateMode(RedeemConfig redeem, SelectionMode mode)
    {
        RedeemConfigService.UpdateRedeemMode(redeem.Id, mode);
    }

    private void UpdateCommandType(RedeemConfig redeem, string commandType)
    {
        RedeemConfigService.UpdateRedeemCommandType(redeem.Id, commandType);
    }

    private async Task FetchRewards()
    {
        StatusMessage = null;
        await InvokeAsync(StateHasChanged);

        var result = await RedeemConfigService.FetchRedeemsAsync();
        StatusIsSuccess = result.Success;

        if (result.Success)
        {
            StatusMessage = $"{result.Message} (+{result.AddedCount} new, {result.UpdatedCount} updated)";
            foreach (var redeem in RedeemConfigService.Config.Redeems)
            {
                ExpandedRedeems.Add(redeem.Id);
            }
        }
        else
        {
            StatusMessage = result.Message;
        }

        await InvokeAsync(StateHasChanged);
    }

    private void ResetCreateForm()
    {
        NewRewardTitle = "";
        NewRewardCost = 100;
        NewRewardPrompt = "";
    }

    private async Task CreateReward()
    {
        if (string.IsNullOrWhiteSpace(NewRewardTitle))
        {
            StatusMessage = "Reward title is required";
            StatusIsSuccess = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        if (NewRewardCost < 1)
        {
            StatusMessage = "Cost must be at least 1 channel point";
            StatusIsSuccess = false;
            await InvokeAsync(StateHasChanged);
            return;
        }

        IsCreatingReward = true;
        StatusMessage = null;
        await InvokeAsync(StateHasChanged);

        var result = await RedeemConfigService.CreateRewardAsync(
            NewRewardTitle,
            NewRewardCost,
            string.IsNullOrWhiteSpace(NewRewardPrompt) ? null : NewRewardPrompt
        );

        IsCreatingReward = false;
        StatusIsSuccess = result.Success;
        StatusMessage = result.Message;

        if (result.Success)
        {
            ShowCreateForm = false;
            ResetCreateForm();
            if (result.RewardId != null)
            {
                var redeem = RedeemConfigService.Config.Redeems.FirstOrDefault(r => r.RewardId == result.RewardId);
                if (redeem != null)
                {
                    ExpandedRedeems.Add(redeem.Id);
                }
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private void StartEditReward(RedeemConfig redeem)
    {
        EditingRewardId = redeem.RewardId;
        EditRewardTitle = redeem.RewardTitle;
        EditRewardCost = redeem.Cost;
        EditRewardPrompt = "";
    }

    private async Task SaveRewardEdit(string rewardId)
    {
        StatusMessage = null;
        await InvokeAsync(StateHasChanged);

        var result = await RedeemConfigService.UpdateRewardAsync(
            rewardId,
            title: EditRewardTitle,
            cost: EditRewardCost,
            prompt: string.IsNullOrWhiteSpace(EditRewardPrompt) ? null : EditRewardPrompt
        );

        StatusIsSuccess = result.Success;
        StatusMessage = result.Message;

        if (result.Success)
        {
            EditingRewardId = null;
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task DeleteReward(string rewardId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this reward? This will remove it from Twitch permanently."))
        {
            return;
        }

        StatusMessage = null;
        await InvokeAsync(StateHasChanged);

        var result = await RedeemConfigService.DeleteRewardAsync(rewardId);
        StatusIsSuccess = result.Success;
        StatusMessage = result.Message;

        await InvokeAsync(StateHasChanged);
    }

    private static SelectionMode ParseSelectionMode(object? value)
    {
        if (value == null) return SelectionMode.All;
        return Enum.TryParse<SelectionMode>(value.ToString(), out var mode) ? mode : SelectionMode.All;
    }

    public void Dispose()
    {
        RedeemConfigService.ConfigChanged -= OnConfigChanged;
    }
}
